<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Family Accounts ‚Äî GitHub Edition</title>
  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --muted:#64748b; --text:#0f172a;
      --accent:#2563eb; --ok:#16a34a; --bad:#dc2626; --chip:#eef2ff; --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#f8fafc,#ffffff);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .title{font-size:22px;font-weight:700;letter-spacing:.3px}
    .small{font-size:12px;color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 8px 24px rgba(2,6,23,.06)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:8px}
    label{font-size:12px;color:var(--muted)}
    input[type="text"],input[type="number"],select,textarea,input[type="month"]{
      width:100%;background:#ffffff;border:1px solid var(--border);color:var(--text);border-radius:12px;padding:12px 12px;font-size:15px;outline:none
    }
    textarea{min-height:88px;resize:vertical}
    .btn{border:1px solid transparent;background:linear-gradient(180deg,var(--accent),#1e4fd9);color:white;border-radius:12px;padding:12px 14px;font-weight:600;font-size:15px;cursor:pointer}
    .btn.alt{background:#f1f5f9;color:var(--text);border-color:var(--border)}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btn.warn{background:linear-gradient(180deg,#ef4444,#dc2626); color:#fff; border:0;}
    .btn:active{transform:translateY(1px)}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:var(--chip);color:#1e3a8a;padding:8px 10px;border-radius:999px;border:1px solid #dbeafe;display:inline-flex;align-items:center;gap:8px}
    .chip .x{cursor:pointer;opacity:.8}
    .section-title{font-weight:700;margin:2px 0 8px 0}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:left;font-size:14px}
    th{color:var(--muted);font-weight:600;background:#f8fafc}
    tfoot td{font-weight:700;background:#f8fafc}
    .seg{display:flex;background:#f1f5f9;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .seg button{flex:1;background:transparent;border:0;color:var(--muted);padding:10px 12px;font-weight:600}
    .seg button.active{color:var(--text);background:#fff}
    .pill{font-weight:700;padding:4px 10px;border-radius:999px}
    .pill.ok{background:#ecfdf5;color:#065f46}
    .pill.bad{background:#fef2f2;color:#7f1d1d}
    .muted{color:var(--muted)}
    .right{margin-left:auto}
    .spacer{height:10px}
    .footer{color:var(--muted);text-align:center;margin:16px 0 24px}
    .note{font-size:12px;color:var(--muted)}
    .big{font-size:20px;font-weight:800}
    .status{font-size:12px;color:var(--muted)}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;background:#f1f5f9;border:1px solid var(--border);border-radius:6px;padding:2px 6px}
    .modeBadge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#f8fafc}
    details{border:1px solid var(--border); border-radius:12px; background:#fff; padding:10px 12px}
    summary{font-weight:700; cursor:pointer; list-style:none}
    summary::-webkit-details-marker{display:none}
    .summary-row{display:flex; align-items:center; gap:8px}
    .tag{font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; background:#f8fafc}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">üè¶ Family Accounts</div>
      <div class="row">
        <button class="btn alt" id="undoBtn" type="button" title="Undo last action">Undo</button>
        <div class="modeBadge" id="modeBadge">Mode: Local storage</div>
        <div class="col" style="min-width:160px">
          <label for="month">Month</label>
          <input type="month" id="month" />
        </div>
        <div class="col">
          <label>Last edited</label>
          <div class="small" id="lastEdited">‚Äî</div>
        </div>
      </div>
    </div>

    <div class="spacer"></div>

    <!-- Collapsible: File options -->
    <details>
      <summary>
        <div class="summary-row">
          <span>File options</span>
          <span class="tag" id="fileStatus">Local-only (no file)</span>
        </div>
      </summary>
      <div class="spacer"></div>
      <div class="row">
        <button class="btn" id="chooseFileBtn" type="button">Choose / Open data file</button>
        <button class="btn ghost" id="createFileBtn" type="button">Create new data file</button>
        <button class="btn ghost" id="reopenBtn" type="button">Reopen last file</button>
        <button class="btn alt" id="importBtn" type="button">Import JSON (backup)</button>
        <input type="file" id="importInput" accept="application/json" style="display:none" />
        <button class="btn alt" id="exportBtn" type="button">Export JSON (backup)</button>
      </div>
      <div class="note">Tip: If you use a Drive JSON here, the app autosaves to it. Otherwise it saves locally in this browser. Export creates a full backup of all months.</div>
    </details>

    <div class="spacer"></div>

    
    <div class="spacer"></div>
    <div class="card">
      <div class="section-title">Copy people & categories from another month</div>
      <div class="row">
        <div class="col" style="min-width:220px;flex:1">
          <label for="copySourceMonth">Source month</label>
          <select id="copySourceMonth"></select>
        </div>
        <button class="btn alt" id="copyMergeBtn" type="button" title="Keep current + add new from source">Copy (Merge)</button>
        <button class="btn ghost" id="copyOverwriteBtn" type="button" title="Replace current with source">Copy (Overwrite)</button>
      </div>
      <div class="note">Only people & categories are copied. Expenses are not changed.</div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="section-title">People</div>
        <div class="row">
          <input id="personName" type="text" placeholder="e.g., Stuart" inputmode="text" autocomplete="off" />
          <button class="btn" id="addPersonBtn" type="button">Add person</button>
        </div>
        <div class="chips" id="peopleChips"></div>
      </div>

      <div class="card">
        <div class="section-title">Categories</div>
        <div class="row">
          <input id="categoryName" type="text" placeholder="e.g., Groceries" />
          <button class="btn" id="addCategoryBtn" type="button">Add category</button>
        </div>
        <div class="chips" id="categoriesChips"></div>
      </div>
    </div>

    <div class="spacer"></div>

    <div class="card">
      <div class="section-title">Add expenses</div>
      <div class="seg" style="margin-bottom:10px">
        <button id="modeQuick" class="active" type="button">Quick add (same category)</button>
        <button id="modeBatch" type="button">Batch add (multiple categories)</button>
      </div>

      <div id="quickPanel">
        <div class="row">
          <div class="col" style="min-width:160px;flex:1">
            <label>Person</label>
            <select id="quickPerson"></select>
          </div>
          <div class="col" style="min-width:160px;flex:1">
            <label>Category</label>
            <select id="quickCategory"></select>
          </div>
        </div>
        <div class="row">
          <div class="col" style="flex:1">
            <label>Amounts (comma / space / new line separated)</label>
            <textarea id="quickAmounts" placeholder="e.g., 12.50, 7, 19.99"></textarea>
            <div class="note">Tip: you can paste many numbers, one per line. Both "," and "." work as decimals.</div>
          </div>
        </div>
        <div class="row">
          <div class="col" style="flex:1">
            <label>Note (optional, applied to all quick-added amounts)</label>
            <input id="quickNote" type="text" placeholder="e.g., supermarket run" />
          </div>
          </div>
        </div>
        <div class="sticky-bar">
          <button class="btn" id="addQuickBtn" type="button">Add expense(s)</button>
          <button class="btn ghost" id="clearQuickBtn" type="button">Clear</button>
        </div>
      </div>

      <div id="batchPanel" style="display:none">
        <div class="row">
          <div class="col" style="min-width:160px;flex:1">
            <label>Person</label>
            <select id="batchPerson"></select>
          </div>
        </div>
        <div id="batchRows"></div>
        <div class="row">
          <button class="btn alt" id="addBatchRowBtn" type="button">+ Add another line</button>
          <div class="right"></div>
          <button class="btn" id="saveBatchBtn" type="button">Save all lines</button>
          <button class="btn ghost" id="clearBatchBtn" type="button">Clear lines</button>
        </div>
        <div class="note">Each line: choose a category and enter amount. Add as many lines as you like for the same person, then tap "Save all lines".</div>
      </div>
    </div>

    <div class="spacer"></div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="section-title">All expenses</div>
        <button class="btn warn" id="clearMonthBtn" type="button">Clear this month‚Äôs expenses</button>
      </div>
      <div class="row" style="justify-content:space-between">
        <div class="muted">Tap üóëÔ∏è to remove a line</div>
      </div>
      <div id="expensesEmpty" class="muted" style="padding:6px 0 12px">No expenses yet.</div>
      <div style="overflow:auto">
        <table id="expensesTable" style="display:none">
          <thead>
            <tr><th>#</th><th>Person</th><th>Category</th><th>Note</th><th>Amount</th><th></th></tr>
          </thead>
          <tbody id="expensesBody"></tbody>
          <tfoot>
            <tr><td colspan="3">Total</td><td id="totalCell">‚Ç¨0.00</td><td></td></tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div class="spacer"></div>

    <div class="grid">
      <div class="card">
        <div class="section-title">Totals by person</div>
        <div id="totalsPeople"></div>
      </div>
      <div class="card">
        <div class="section-title">Totals by category</div>
        <div id="totalsCategories"></div>
      </div>
    </div>

    <div class="spacer"></div>

    <div class="card">
      <div class="section-title">Who owes who</div>
      <div id="settlements"></div>
      <div class="note">Everyone should pay an equal share of the month‚Äôs total. Positive balances are owed money; negative balances owe money.</div>
    </div>

    <div class="spacer"></div>

    <div class="card">
      <div class="section-title">Averages</div>
      <div class="row">
        <div class="col">
          <label>Average monthly spend ‚Äî YTD</label>
          <div id="avgYTD" class="big">‚Ç¨0.00</div>
        </div>
        <div class="col">
          <label>Average monthly spend ‚Äî All saved months</label>
          <div id="avgAll" class="big">‚Ç¨0.00</div>
        </div>
      </div>
      <div class="spacer"></div>
      <div class="grid">
        <div>
          <div class="section-title">Average by category ‚Äî YTD</div>
          <div id="avgCatYTD"></div>
        </div>
        <div>
          <div class="section-title">Average by category ‚Äî All</div>
          <div id="avgCatAll"></div>
        </div>
      </div>
    </div>

    <div class="footer">stuartscottAI</div>
  </div>

  <script>
    // ---------- Core selectors ----------
    const monthEl = document.getElementById('month');
    const modeBadge = document.getElementById('modeBadge');
    const lastEditedEl = document.getElementById('lastEdited');

    const personNameEl = document.getElementById('personName');
    const addPersonBtn = document.getElementById('addPersonBtn');
    const peopleChips = document.getElementById('peopleChips');

    const categoryNameEl = document.getElementById('categoryName');
    const addCategoryBtn = document.getElementById('addCategoryBtn');
    const categoriesChips = document.getElementById('categoriesChips');

    const modeQuickBtn = document.getElementById('modeQuick');
    const modeBatchBtn = document.getElementById('modeBatch');
    const quickPanel = document.getElementById('quickPanel');
    const batchPanel = document.getElementById('batchPanel');

    const quickPerson = document.getElementById('quickPerson');
    const quickCategory = document.getElementById('quickCategory');
    const quickAmounts = document.getElementById('quickAmounts');
    const addQuickBtn = document.getElementById('addQuickBtn');
    const clearQuickBtn = document.getElementById('clearQuickBtn');

    const batchPerson = document.getElementById('batchPerson');
    const batchRows = document.getElementById('batchRows');
    const addBatchRowBtn = document.getElementById('addBatchRowBtn');
    const saveBatchBtn = document.getElementById('saveBatchBtn');
    const clearBatchBtn = document.getElementById('clearBatchBtn');

    const expensesEmpty = document.getElementById('expensesEmpty');
    const expensesTable = document.getElementById('expensesTable');
    const expensesBody = document.getElementById('expensesBody');
    const totalCell = document.getElementById('totalCell');

    const totalsPeople = document.getElementById('totalsPeople');
    const totalsCategories = document.getElementById('totalsCategories');
    const settlements = document.getElementById('settlements');

    const clearMonthBtn = document.getElementById('clearMonthBtn');

    // Averages
    const avgYTD = document.getElementById('avgYTD');
    const avgAll = document.getElementById('avgAll');
    const avgCatYTD = document.getElementById('avgCatYTD');
    const avgCatAll = document.getElementById('avgCatAll');

    // File & data mgmt selectors
    const chooseFileBtn = document.getElementById('chooseFileBtn');
    const createFileBtn = document.getElementById('createFileBtn');
    const reopenBtn = document.getElementById('reopenBtn');
    const fileStatus = document.getElementById('fileStatus');
    const importBtn = document.getElementById('importBtn');
    const exportBtn = document.getElementById('exportBtn');
    const importInput = document.getElementById('importInput');

    // ---------- App state ----------
    // ---------- Undo history ----------
    let __history = [];
    const __HISTORY_LIMIT = 50;
    function snapshotAll() {
      // Capture all local famacct:* months
      const locals = {};
      for (let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(k && k.startsWith('famacct:')) { locals[k] = localStorage.getItem(k); }
      }
      // Capture file months if any
      const fileMonths = fileHandle ? JSON.stringify(fileData.months||{}) : null;
      return JSON.stringify({locals, fileMonths, fileMode: !!fileHandle, currentMonth: monthEl.value});
    }
    function pushHistory(){
      const snap = snapshotAll();
      __history.push(snap);
      if(__history.length > __HISTORY_LIMIT) __history.shift();
    }
    async function undoLastAction(){
      if(!__history.length){ alert('Nothing to undo.'); return; }
      const raw = __history.pop();
      try{
        const {locals, fileMonths, fileMode, currentMonth} = JSON.parse(raw);
        // Restore locals
        // First clear existing famacct:* to avoid leftovers
        const toRemove = [];
        for (let i=0;i<localStorage.length;i++){
          const k = localStorage.key(i);
          if(k && k.startsWith('famacct:')) toRemove.push(k);
        }
        for(const k of toRemove) localStorage.removeItem(k);
        for(const [k,v] of Object.entries(locals)) localStorage.setItem(k, v);
        // Restore file months only if file mode matches current state and we have a handle
        if(fileMode && fileHandle && fileMonths){
          try{ fileData.months = JSON.parse(fileMonths) || {}; }catch{ fileData.months = {}; }
          try{ await writeFileJSON(fileHandle, fileData); }catch{}
        }
        await loadFromFileOrLocal(currentMonth);
        lastLoadedMonth = currentMonth;
        monthEl.value = currentMonth;
        renderAll(); renderAverages(); updateFileStatus();
      }catch(e){
        console.error('Undo failed', e);
        alert('Undo failed. Sorry!');
      }
    }

    let data = null; // current month data
    let fileHandle = null; // FileSystemFileHandle
    let fileData = { months: {} }; // consolidated months when using a file
    let saveDebounce = null;
    const HANDLE_DB = 'famacct-db';
    const HANDLE_KEY = 'dataFile';
    let lastLoadedMonth = null;
    let lastMonthSnapshot = null; // for copying people/categories when creating new month

    // ---------- Utilities ----------
    function thisMonthValue(){
      const d = new Date();
      const m = String(d.getMonth()+1).padStart(2,'0');
      return `${d.getFullYear()}-${m}`;
    }
    function keyFor(month){ return `famacct:${month}` }
    function defaultData(copyFrom){
      return {people:(copyFrom?.people||[]), categories:(copyFrom?.categories||[]), expenses:[], lastEdited: new Date().toISOString()};
    }
    function euro(n){ return n.toLocaleString('es-ES',{style:'currency',currency:'EUR'}) }
    function round2(n){ return Math.round((n+Number.EPSILON)*100)/100 }
    function debounceSave(){ clearTimeout(saveDebounce); saveDebounce = setTimeout(()=>persist(), 400); }
    function setModeBadge(){ modeBadge.textContent = fileHandle ? `Mode: Drive file ‚Äî ${fileHandle.name}` : 'Mode: Local storage'; }
    function formatUK(iso){
      if(!iso) return '‚Äî';
      const d = new Date(iso);
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      const HH = String(d.getHours()).padStart(2,'0');
      const min = String(d.getMinutes()).padStart(2,'0');
      return `${dd}/${mm}/${yyyy} ${HH}:${min}`;
    }
    function setLastEditedNow(){
      if(data){ data.lastEdited = new Date().toISOString(); renderLastEdited(); }
    }
    function renderLastEdited(){ lastEditedEl.textContent = formatUK(data?.lastEdited); }

    // ---------- Storage: Local ----------
    function localLoadMonth(month){
      const raw = localStorage.getItem(keyFor(month));
      if(raw){ 
        try{ data = JSON.parse(raw)||defaultData(null); }catch{ data = defaultData(null); } 
        if(!data.lastEdited){ data.lastEdited = new Date().toISOString(); }
      } else {
        data = defaultData(null);
        localStorage.setItem(keyFor(month), JSON.stringify(data));
      }
    }
    function localSaveCurrent(){ localStorage.setItem(keyFor(monthEl.value), JSON.stringify(data)); }
    function localMirrorAllFromFile(){
      const months = Object.keys(fileData.months||{});
      for(const m of months){
        try{ localStorage.setItem(keyFor(m), JSON.stringify(fileData.months[m])); }catch{}
      }
    }
    function listSavedMonthsLocal(){
      const months = [];
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(k && k.startsWith('famacct:')) months.push(k.split(':')[1]);
      }
      months.sort((a,b)=> a<b?1:(a>b?-1:0));
      return months;
    }

    // ---------- Storage: File ----------
    async function ensureRW(handle){
      if(!handle) return false;
      const p = await handle.queryPermission({mode:'readwrite'});
      if(p==='granted') return true;
      const req = await handle.requestPermission({mode:'readwrite'});
      return req==='granted';
    }
    async function readFileJSON(handle){
      const file = await handle.getFile();
      const text = await file.text();
      try{ return JSON.parse(text); }catch{ return {months:{}} }
    }
    async function writeFileJSON(handle, obj){
      const writable = await handle.createWritable();
      await writable.write(JSON.stringify(obj, null, 2));
      await writable.close();
    }
    function listSavedMonthsFile(){ return Object.keys(fileData.months||{}).sort((a,b)=> a<b?1:(a>b?-1:0)); }

    // ---------- IndexedDB handle store ----------
    function idbOpen(){
      return new Promise((resolve, reject)=>{
        const req = indexedDB.open(HANDLE_DB, 1);
        req.onupgradeneeded = ()=>{
          const db = req.result;
          if(!db.objectStoreNames.contains('handles')) db.createObjectStore('handles');
        };
        req.onsuccess = ()=>resolve(req.result);
        req.onerror = ()=>reject(req.error);
      });
    }
    async function idbSet(key, val){
      const db = await idbOpen();
      return new Promise((resolve,reject)=>{
        const tx = db.transaction('handles','readwrite');
        tx.objectStore('handles').put(val, key);
        tx.oncomplete = ()=>resolve();
        tx.onerror = ()=>reject(tx.error);
      });
    }
    async function idbGet(key){
      const db = await idbOpen();
      return new Promise((resolve,reject)=>{
        const tx = db.transaction('handles','readonly');
        const req = tx.objectStore('handles').get(key);
        req.onsuccess = ()=>resolve(req.result);
        req.onerror = ()=>reject(req.error);
      });
    }

    // ---------- Shared load/save ----------
    function monthExists(month){
      if(fileHandle) return !!(fileData.months && fileData.months[month]);
      return localStorage.getItem(keyFor(month)) != null;
    }

    async function loadFromFileOrLocal(month){
      if(fileHandle){
        data = fileData.months[month];
        if(!data){
          const localRaw = localStorage.getItem(keyFor(month));
          if(localRaw){
            try{ data = JSON.parse(localRaw); }catch{ data = defaultData(null); }
          } else {
            data = defaultData(null);
          }
        }
      } else {
        localLoadMonth(month);
      }
    }

    function persist(){
      try{ localSaveCurrent(); }catch{}
      if(fileHandle){
        fileData.months[monthEl.value] = data;
        writeFileJSON(fileHandle, fileData).then(()=>{
          fileStatus.textContent = `File: ${fileHandle.name} ‚Äî saved`;
        }).catch(err=>{
          console.error(err);
          fileStatus.textContent = `File: ${fileHandle.name} ‚Äî save failed (working locally)`;
        });
      }
      renderAverages();
    }

    
    // ---------- Copy people & categories from another month ----------
    function uniqueList(arr){ return Array.from(new Set((arr||[]).map(s=>String(s).trim()).filter(Boolean))); }
    function populateCopySource(){
      const sel = document.getElementById('copySourceMonth');
      if(!sel) return;
      const months = listSavedMonths().filter(m => m !== monthEl.value);
      sel.innerHTML = '';
      const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='‚Äî select month ‚Äî'; sel.appendChild(opt0);
      for(const m of months){ const o=document.createElement('option'); o.value=m; o.textContent=m; sel.appendChild(o); }
    }
    function copyPeopleCategoriesFrom(srcMonth, mode){
      if(!srcMonth){ alert('Choose a source month'); return; }
      if(srcMonth === monthEl.value){ alert('Source and current month are the same'); return; }
      const src = getMonthData(srcMonth);
      if(!src){ alert('No data found for that month'); return; }
      // Only people & categories
      const srcPeople = uniqueList(src.people||[]);
      const srcCats = uniqueList(src.categories||[]);
      if(mode === 'overwrite'){
        data.people = srcPeople;
        data.categories = srcCats;
      }else{
        data.people = uniqueList([...(data.people||[]), ...srcPeople]);
        data.categories = uniqueList([...(data.categories||[]), ...srcCats]);
      }
      save(); renderAll();
      alert('Copied ' + (mode==='overwrite'?'(overwrite)':'(merge)') + ' from ' + srcMonth);
    }

    // ---------- Computations & Rendering ----------
    function computeTotals(){
      const perPerson = Object.fromEntries(data.people.map(p=>[p,0]));
      const perCategory = Object.fromEntries(data.categories.map(c=>[c,0]));
      let grand=0;
      for(const e of data.expenses){
        if(perPerson[e.person]===undefined) perPerson[e.person]=0;
        if(perCategory[e.category]===undefined) perCategory[e.category]=0;
        perPerson[e.person]+=e.amount;
        perCategory[e.category]+=e.amount;
        grand+=e.amount;
      }
      perPerson.__total = round2(grand);
      return {perPerson, perCategory};
    }
    function renderPeopleCats(){
      peopleChips.innerHTML = '';
      for(const p of data.people){
        const c = document.createElement('span');
        c.className='chip';
        c.innerHTML = '<span>'+p+'</span><span class="x" title="Remove">‚úñ</span>';
        c.querySelector('.x').addEventListener('click',()=>{ if(confirm('Remove '+p+' and their expenses?')) { removePerson(p); }});
        peopleChips.appendChild(c);
      }
      categoriesChips.innerHTML = '';
      for(const cName of data.categories){
        const c = document.createElement('span');
        c.className='chip';
        c.innerHTML = '<span>'+cName+'</span><span class="x" title="Remove">‚úñ</span>';
        c.querySelector('.x').addEventListener('click',()=>{ if(confirm('Remove category "'+cName+'" and related expenses?')) { removeCategory(cName); }});
        categoriesChips.appendChild(c);
      }
      fillSelect(quickPerson, data.people);
      fillSelect(quickCategory, data.categories);
      fillSelect(batchPerson, data.people);
      [...batchRows.querySelectorAll('.batchCategory')].forEach(sel=>fillSelect(sel, data.categories));
    }
    function renderExpenses(){
      if(!data.expenses.length){
        expensesEmpty.style.display='block';
        expensesTable.style.display='none';
        totalCell.textContent = euro(0);
        expensesBody.innerHTML = '';
        return;
      }
      expensesEmpty.style.display='none';
      expensesTable.style.display='table';
      expensesBody.innerHTML = '';
      let i=1, total=0;
      for(const [idx,e] of data.expenses.entries()){
        total += e.amount;
        const tr = document.createElement('tr');
        tr.innerHTML = '<td>'+ (i++) +'</td><td>'+e.person+'</td><td>'+e.category+'</td><td>'+(e.note?String(e.note).replace(/</g,'&lt;'):'')+'</td><td>'+euro(e.amount)+'</td><td><button class="btn ghost" title="Delete" data-i="'+idx+'" type="button">üóëÔ∏è</button></td>';
        tr.querySelector('button').addEventListener('click',()=>{ data.expenses.splice(idx,1); save(); renderAll(); });
        expensesBody.appendChild(tr);
      }
      totalCell.textContent = euro(round2(total));
    }
    function renderTotals(){
      const {perPerson, perCategory} = computeTotals();
      const total = perPerson.__total || 0;
      let htmlP='';
      if(data.people.length){
        htmlP += '<table><thead><tr><th>Person</th><th>Total</th></tr></thead><tbody>';
        for(const p of data.people){
          htmlP += '<tr><td>'+p+'</td><td>'+euro(round2(perPerson[p]||0))+'</td></tr>';
        }
        htmlP += '</tbody><tfoot><tr><td>All people</td><td>'+euro(round2(total))+'</td></tr></tfoot></table>';
      } else htmlP = '<div class="muted">Add some people to see totals.</div>';
      totalsPeople.innerHTML = htmlP;

      let htmlC='';
      if(data.categories.length){
        htmlC += '<table><thead><tr><th>Category</th><th>Total</th></tr></thead><tbody>';
        for(const c of data.categories){
          htmlC += '<tr><td>'+c+'</td><td>'+euro(round2(perCategory[c]||0))+'</td></tr>';
        }
        htmlC += '</tbody><tfoot><tr><td>All categories</td><td>'+euro(round2(total))+'</td></tr></tfoot></table>';
      } else htmlC = '<div class="muted">Add some categories to see totals.</div>';
      totalsCategories.innerHTML = htmlC;
    }
    function computeSettlements(){
      const {perPerson} = computeTotals();
      const people = data.people;
      const total = perPerson.__total || 0;
      const n = people.length || 1;
      const share = round2(total / n);
      const balances = people.map(p=>({person:p, balance: round2((perPerson[p]||0) - share)}));
      const creditors = balances.filter(b=>b.balance>0).map(b=>({...b})).sort((a,b)=>b.balance-a.balance);
      const debtors = balances.filter(b=>b.balance<0).map(b=>({...b})).sort((a,b)=>a.balance-b.balance);
      const transfers = [];
      let ci=0, di=0;
      while(ci<creditors.length && di<debtors.length){
        const c = creditors[ci], d = debtors[di];
        const amt = round2(Math.min(c.balance, -d.balance));
        if(amt>0){
          transfers.push({from:d.person,to:c.person,amount:amt});
          c.balance = round2(c.balance - amt);
          d.balance = round2(d.balance + amt);
        }
        if(c.balance<=0.0001) ci++;
        if(d.balance>=-0.0001) di++;
      }
      return {share, balances, transfers};
    }
    function renderSettlements(){
      const {share, balances, transfers} = computeSettlements();
      if(!data.people.length){ settlements.innerHTML = '<div class="muted">Add people first.</div>'; return; }
      let html = '<div class="row"><div>Equal share per person: <strong>'+euro(share)+'</strong></div></div>';
      html += '<div class="spacer"></div>';
      html += '<table><thead><tr><th>Person</th><th>Balance vs share</th></tr></thead><tbody>';
      for(const b of balances){
        const cls = b.balance>=0? 'ok' : 'bad';
        html += '<tr><td>'+b.person+'</td><td><span class="pill '+cls+'">'+(b.balance>=0?'+':'')+euro(b.balance)+'</span></td></tr>';
      }
      html += '</tbody></table>';
      html += '<div class="spacer"></div>';
      if(!transfers.length){ html += '<div class="muted">No transfers needed ‚úÖ</div>'; }
      else{
        html += '<div class="section-title">Suggested transfers</div>';
        html += '<table><thead><tr><th>From</th><th>To</th><th>Amount</th></tr></thead><tbody>';
        for(const t of transfers){ html += '<tr><td>'+t.from+'</td><td>'+t.to+'</td><td>'+euro(t.amount)+'</td></tr>'; }
      }
      settlements.innerHTML = html;
    }
    function renderAll(){
      renderPeopleCats(); renderExpenses(); renderTotals(); renderSettlements(); renderLastEdited();
    }

    function fillSelect(selectEl, items){
      selectEl.innerHTML = '';
      const opt = document.createElement('option'); opt.value=''; opt.textContent='‚Äî select ‚Äî'; selectEl.appendChild(opt);
      for(const it of items){ const o = document.createElement('option'); o.value=it; o.textContent=it; selectEl.appendChild(o); }
    }

    // Averages across months (from local or file)
    function listSavedMonths(){
      return fileHandle ? listSavedMonthsFile() : listSavedMonthsLocal();
    }
    function getMonthData(m){
      if(fileHandle) return fileData.months[m] || defaultData(null);
      const raw = localStorage.getItem(keyFor(m)); if(!raw) return defaultData(null);
      try{ return JSON.parse(raw); }catch{return defaultData(null);}
    }
    function computeAverages(){
      const months = listSavedMonths();
      const allData = months.map(m=>({m, d:getMonthData(m)})).filter(x=>x.d);
      const year = new Date().getFullYear();
      const ytd = allData.filter(x => x.m.startsWith(year + '-'));
      const allMonthsCount = allData.length, ytdMonthsCount = ytd.length;
      const sumTotal = (arr)=> arr.reduce((s,x)=> s + (x.d.expenses||[]).reduce((a,e)=>a+(e.amount||0),0), 0);
      const totalAll = sumTotal(allData), totalYTD = sumTotal(ytd);
      const avgAllVal = allMonthsCount ? round2(totalAll / allMonthsCount) : 0;
      const avgYTDVal = ytdMonthsCount ? round2(totalYTD / ytdMonthsCount) : 0;
      const catsAllTotals = {}, catsYtdTotals = {}; const catSetAll = new Set(), catSetYTD = new Set();
      allData.forEach(({d})=>{ (d.categories||[]).forEach(c=>catSetAll.add(c)); (d.expenses||[]).forEach(e=>{ catsAllTotals[e.category]=(catsAllTotals[e.category]||0)+(e.amount||0); }); });
      ytd.forEach(({d})=>{ (d.categories||[]).forEach(c=>catSetYTD.add(c)); (d.expenses||[]).forEach(e=>{ catsYtdTotals[e.category]=(catsYtdTotals[e.category]||0)+(e.amount||0); }); });
      const avgCatAllMap = {}, avgCatYTDMap = {};
      for(const c of catSetAll){ avgCatAllMap[c] = allMonthsCount ? round2((catsAllTotals[c]||0)/allMonthsCount) : 0; }
      for(const c of catSetYTD){ avgCatYTDMap[c] = ytdMonthsCount ? round2((catsYtdTotals[c]||0)/ytdMonthsCount) : 0; }
      return {avgAllVal, avgYTDVal, avgCatAllMap, avgCatYTDMap, allMonthsCount, ytdMonthsCount};
    }
    function tableFromMap(mapObj, leftHeader, rightHeader){
      const keys = Object.keys(mapObj).sort((a,b)=> mapObj[b]-mapObj[a]); if(!keys.length) return '<div class="muted">No data yet.</div>';
      let html = '<table><thead><tr><th>'+leftHeader+'</th><th>'+rightHeader+'</th></tr></thead><tbody>';
      for(const k of keys){ html += '<tr><td>'+k+'</td><td>'+euro(mapObj[k])+'</td></tr>'; }
      html += '</tbody></table>'; return html;
    }
    function renderAverages(){
      const {avgAllVal, avgYTDVal, avgCatAllMap, avgCatYTDMap, allMonthsCount, ytdMonthsCount} = computeAverages();
      avgAll.textContent = euro(avgAllVal) + (allMonthsCount?(' ('+allMonthsCount+' mo.)'):'');
      avgYTD.textContent = euro(avgYTDVal) + (ytdMonthsCount?(' ('+ytdMonthsCount+' mo. YTD)'):'');
      avgCatAll.innerHTML = tableFromMap(avgCatAllMap, 'Category', 'Avg / month (All)');
      avgCatYTD.innerHTML = tableFromMap(avgCatYTDMap, 'Category', 'Avg / month (YTD)');
    }

    // ---------- File & data mgmt ----------
    function updateFileStatus(){
      if(fileHandle){ fileStatus.textContent = 'File: '+fileHandle.name; }
      else { fileStatus.textContent = 'Local-only (no file)'; }
      setModeBadge();

      // populate copy source on load
      populateCopySource();
    }

    function mergeCurrentMonthLocalIntoFile(){
      const m = monthEl.value;
      if(!fileHandle) return;
      if(fileData.months[m]) return; // file already has it
      const raw = localStorage.getItem(keyFor(m));
      if(!raw) return;
      try{
        const local = JSON.parse(raw);
        fileData.months[m] = local;
      }catch{}
    }

    async function chooseOpenFile(){
      try{
        if(!window.showOpenFilePicker){ alert('Your browser does not support this file picker. Use Import JSON instead.'); return; }
        const [h] = await window.showOpenFilePicker({
          multiple:false,
          types:[{description:'JSON', accept:{'application/json':['.json']}}]
        });
        if(!h) return;
        if(!(await ensureRW(h))) { alert('No permission to read/write this file.'); return; }
        fileHandle = h;
        fileData = await readFileJSON(fileHandle);
        if(!fileData || typeof fileData!=='object' || !fileData.months){ fileData = {months:{}}; }
        mergeCurrentMonthLocalIntoFile();
        await writeFileJSON(fileHandle, fileData);
        localMirrorAllFromFile();
        await idbSet(HANDLE_KEY, fileHandle);
        updateFileStatus();
        await loadFromFileOrLocal(monthEl.value);
        renderAll(); renderAverages();
      }catch(e){ /* canceled */ }
    }

    async function createNewFile(){
      try{
        if(!window.showSaveFilePicker){ alert('Your browser does not support creating files here. Use Export JSON to create one.'); return; }
        const h = await window.showSaveFilePicker({
          suggestedName:'family-accounts.json',
          types:[{description:'JSON', accept:{'application/json':['.json']}}]
        });
        if(!(await ensureRW(h))) { alert('No permission to write this file.'); return; }
        fileHandle = h;
        fileData = {months:{}};
        mergeCurrentMonthLocalIntoFile();
        await writeFileJSON(fileHandle, fileData);
        await idbSet(HANDLE_KEY, fileHandle);
        updateFileStatus();
        await loadFromFileOrLocal(monthEl.value);
        renderAll(); renderAverages();
      }catch(e){ /* canceled */ }
    }

    async function reopenLastFile(){
      try{
        const h = await idbGet(HANDLE_KEY);
        if(!h){ alert('No stored file handle yet. Choose a data file first.'); return; }
        if(!(await ensureRW(h))) { alert('Permission to the previous file was revoked. Please choose it again.'); return; }
        fileHandle = h;
        fileData = await readFileJSON(fileHandle);
        if(!fileData || typeof fileData!=='object' || !fileData.months){ fileData = {months:{}}; }
        mergeCurrentMonthLocalIntoFile();
        await writeFileJSON(fileHandle, fileData);
        localMirrorAllFromFile();
        updateFileStatus();
        await loadFromFileOrLocal(monthEl.value);
        renderAll(); renderAverages();
      }catch(e){
        alert('Could not reopen last file. Please choose it again.');
      }
    }

    // Import / Export
    function importJSON(obj){
      if(obj && obj.months && typeof obj.months === 'object'){
        // Merge into fileData
        fileData = {months:{...fileData.months, ...obj.months}};
      } else if (obj && (obj.people || obj.categories || obj.expenses)){
        const m = monthEl.value || thisMonthValue();
        fileData.months[m] = obj;
      } else {
        alert('This JSON does not look like a Family Accounts export.');
        return;
      }
      // Mirror to localStorage
      for(const m of Object.keys(fileData.months)){
        try{ localStorage.setItem(keyFor(m), JSON.stringify(fileData.months[m])); }catch{}
      }
      // If a Drive file is open, also persist into it
      if(fileHandle){
        writeFileJSON(fileHandle, fileData).catch(()=>{});
      }
      if(fileData.months[monthEl.value]){
        data = fileData.months[monthEl.value];
      }
      renderAll(); renderAverages();
      alert('Import complete!');
    }

    function downloadBlob(obj, filename){
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    importBtn.addEventListener('click', ()=> importInput.click());
    importInput.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      try{
        const text = await f.text();
        const obj = JSON.parse(String(text).replace(/^\uFEFF/, '').trim());
        importJSON(obj);
      }catch(err){
        alert('Could not read that JSON.');
      } finally {
        importInput.value = '';
      }
    });

    exportBtn.addEventListener('click', ()=>{
      const out = {months:{}};
      const months = new Set([...(fileHandle?Object.keys(fileData.months):[]), ...listSavedMonthsLocal()]);
      for(const m of months){
        const raw = localStorage.getItem(keyFor(m));
        if(raw){ try{ out.months[m] = JSON.parse(raw); }catch{} }
        if(!out.months[m] && fileHandle && fileData.months[m]) out.months[m] = fileData.months[m];
      }
      downloadBlob(out, 'family-accounts-backup.json');
    });

    // ---------- Month switching logic (SAFE) ----------
    async function switchMonthSafely(targetMonth){
      if(targetMonth === lastLoadedMonth) return;
      lastMonthSnapshot = data ? {people:[...(data.people||[])], categories:[...(data.categories||[])]} : null;

      if(monthExists(targetMonth)){
        await loadFromFileOrLocal(targetMonth);
      } else {
        const base = lastMonthSnapshot || {people:[], categories:[]};
        const fresh = defaultData(base);
        if(fileHandle){
          fileData.months[targetMonth] = fresh;
          await writeFileJSON(fileHandle, fileData);
        } else {
          localStorage.setItem(keyFor(targetMonth), JSON.stringify(fresh));
        }
        data = fresh;
      }
      lastLoadedMonth = targetMonth;
      monthEl.value = targetMonth;
      renderLastEdited();
      persist();
      renderAll();
    }

    // ---------- Public actions ----------
    function setMonthToNow(){ monthEl.value = thisMonthValue(); }
    function loadMonth(month){ loadFromFileOrLocal(month).then(()=>{ renderAll(); renderAverages(); }); }

    function save(){ pushHistory(); setLastEditedNow(); persist(); }
    function addPerson(name){
      name = (name||'').trim();
      if(!name) return;
      if(data.people.includes(name)) return;
      data.people.push(name); save(); renderPeopleCats();
    }
    function removePerson(name){
      data.people = data.people.filter(p=>p!==name);
      data.expenses = data.expenses.filter(e=>e.person!==name);
      save(); renderAll();
    }
    function addCategory(name){
      name = (name||'').trim();
      if(!name) return;
      if(data.categories.includes(name)) return;
      data.categories.push(name); save(); renderPeopleCats();
    }
    function removeCategory(name){
      data.categories = data.categories.filter(c=>c!==name);
      data.expenses = data.expenses.filter(e=>e.category!==name);
      save(); renderAll();
    }
    function parseAmounts(text){
      const tokens = String(text).split(/[\s,;]+/).map(t=>t.trim()).filter(Boolean);
      const nums = [];
      for(const t of tokens){ const cleaned=t.replace(/\u20ac/g,'').replace(/,/g,'.'); const n=parseFloat(cleaned); if(!isNaN(n)) nums.push(n); }
      return nums;
    }
    function addQuickExpenses(){
      const person = quickPerson.value;
      const category = quickCategory.value;
      if(!person || !category){ alert('Please select a person and category'); return; }
      const amounts = parseAmounts(quickAmounts.value);
      if(!amounts.length){ alert('Add at least one amount'); return; }
      const note = document.getElementById('quickNote') ? document.getElementById('quickNote').value.trim() : '';
      for(const a of amounts){ if(a<=0) continue; data.expenses.push({person, category, amount: round2(a), note}); }
      save(); renderAll(); quickAmounts.value='';
    }
    function makeBatchRow(category=''){
      const row=document.createElement('div'); row.className='row';
      row.innerHTML='\
        <div class="col" style="flex:1;min-width:160px"><label>Category</label><select class="batchCategory"></select></div>\
        <div class="col" style="width:160px"><label>Amount</label><input class="batchAmount" type="number" inputmode="decimal" step="0.01" placeholder="0.00"/></div>\
        <div class="col" style="flex:1;min-width:200px"><label>Note (optional)</label><input class="batchNote" type="text" placeholder="e.g., receipt #1234"/></div>\
        <button class="btn ghost removeRowBtn" type="button" title="Remove">üóëÔ∏è</button>';
      const sel=row.querySelector('.batchCategory'); fillSelect(sel, data.categories); if(category) sel.value=category;
      row.querySelector('.removeRowBtn').addEventListener('click',()=>row.remove());
      return row;
    }
    function saveBatch(){
      const person=batchPerson.value; if(!person){ alert('Select a person'); return; }
      const rows=[...batchRows.querySelectorAll('.row')]; if(!rows.length){ alert('Add at least one line'); return; }
      let added=0;
      for(const r of rows){
        const cat=r.querySelector('.batchCategory').value;
        const val=parseFloat(r.querySelector('.batchAmount').value);
        const note=(r.querySelector('.batchNote')?.value||'').trim();
        if(cat && isFinite(val) && val>0){ data.expenses.push({person, category:cat, amount: round2(val), note}); added++; }
      }
      if(!added){ alert('Please enter valid amounts'); return; }
      batchRows.innerHTML=''; save(); renderAll();
    }

    // ---------- Init & events ----------
    document.addEventListener('DOMContentLoaded', async ()=>{
      const initial = thisMonthValue();
      monthEl.value = initial;
      await loadFromFileOrLocal(initial);
      lastLoadedMonth = initial;
      lastMonthSnapshot = data ? {people:[...(data.people||[])], categories:[...(data.categories||[])]} : null;
      renderAll();
      renderAverages();
      setModeBadge();

      // populate copy source on load
      populateCopySource();

      // Copy controls
      document.getElementById('copyMergeBtn').addEventListener('click', ()=>{
        const src = document.getElementById('copySourceMonth').value; copyPeopleCategoriesFrom(src, 'merge');
      });
      document.getElementById('copyOverwriteBtn').addEventListener('click', ()=>{
        const src = document.getElementById('copySourceMonth').value; if(!src) return alert('Choose a source month');
        if(confirm('Replace current people & categories with those from '+src+'?')) copyPeopleCategoriesFrom(src, 'overwrite');
      });

      // Month picker change -> safe switch
      monthEl.addEventListener('change', async ()=>{
        populateCopySource();
        const target = monthEl.value;
        await switchMonthSafely(target);
      });

      addPersonBtn.addEventListener('click', ()=>{ const v = personNameEl.value; personNameEl.value=''; addPerson(v); personNameEl.focus(); });
      personNameEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ addPersonBtn.click(); }});

      addCategoryBtn.addEventListener('click', ()=>{ const v = categoryNameEl.value; categoryNameEl.value=''; addCategory(v); categoryNameEl.focus(); });

      modeQuickBtn.addEventListener('click', ()=>{ modeQuickBtn.classList.add('active'); modeBatchBtn.classList.remove('active'); quickPanel.style.display='block'; batchPanel.style.display='none'; });
      modeBatchBtn.addEventListener('click', ()=>{ modeBatchBtn.classList.add('active'); modeQuickBtn.classList.remove('active'); quickPanel.style.display='none'; batchPanel.style.display='block'; if(!batchRows.children.length) batchRows.appendChild(makeBatchRow()); });

      addQuickBtn.addEventListener('click', addQuickExpenses);
      clearQuickBtn.addEventListener('click', ()=>{ quickAmounts.value=''; });

      addBatchRowBtn.addEventListener('click', ()=> batchRows.appendChild(makeBatchRow()));
      saveBatchBtn.addEventListener('click', saveBatch);
      clearBatchBtn.addEventListener('click', ()=>{ batchRows.innerHTML=''; });

      clearMonthBtn.addEventListener('click', ()=>{
        const msg = "Are you sure you want to delete this month's expenses? You won't be able to get them back.";
        if(confirm(msg)){
          const m = monthEl.value;
          const safeName = (s)=> s.replace(/[^A-Za-z0-9_\-]/g,'-');
          const monthLabel = new Date(m + '-01T00:00:00').toLocaleString('en-GB',{month:'long', year:'numeric'}).replace(' ', '-');
          const backup = {months:{}}; backup.months[m] = JSON.parse(JSON.stringify(data));
          const blob = new Blob([JSON.stringify(backup, null, 2)], {type:'application/json'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href=url; a.download=`family-accounts-backup-${safeName(monthLabel)}.json`;
          document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
          data.expenses = []; save(); renderAll();
        }
      });

      // File buttons
      chooseFileBtn.addEventListener('click', chooseOpenFile);
      createFileBtn.addEventListener('click', createNewFile);
      reopenBtn.addEventListener('click', reopenLastFile);

      document.getElementById('undoBtn').addEventListener('click', undoLastAction);

      // Auto-reconnect last Drive file if permission is still granted
      try{
        const h = await idbGet(HANDLE_KEY);
        if(h){
          const ok = await h.queryPermission({mode:'readwrite'});
          if(ok==='granted'){
            fileHandle = h; fileData = await readFileJSON(fileHandle);
            // Merge current local month to file if it's missing to prevent loss
            mergeCurrentMonthLocalIntoFile();
            await writeFileJSON(fileHandle, fileData);
            localMirrorAllFromFile();
            updateFileStatus();
            await loadFromFileOrLocal(initial);
            lastLoadedMonth = initial;
            renderAll();
            renderAverages();
          }
        }
      }catch{}
    });
  </script>
</body>
</html>
