<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Family Accounts ‚Äî Updated</title>
  <style>
    :root{
      --bg-start:#0f0f23; --bg-end:#1a1a3e;
      --card-bg:rgba(255,255,255,0.05); --card-border:rgba(255,255,255,0.1);
      --text:#ffffff; --text-muted:rgba(255,255,255,0.6);
      --accent-start:#667eea; --accent-end:#764ba2;
      --accent-glow:rgba(102,126,234,0.3);
      --success:#10b981; --error:#ef4444;
      --input-bg:rgba(255,255,255,0.08); --input-border:rgba(255,255,255,0.15);
    }

    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes shimmer{0%{background-position:-200% center}100%{background-position:200% center}}
    @keyframes glow{0%,100%{box-shadow:0 0 20px var(--accent-glow)}50%{box-shadow:0 0 30px var(--accent-glow),0 0 50px var(--accent-glow)}}

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;scroll-behavior:smooth}
    body{
      margin:0;
      background:linear-gradient(135deg,var(--bg-start) 0%,var(--bg-end) 100%);
      background-attachment:fixed;
      color:var(--text);
      font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;
      line-height:1.6;
      position:relative;
      overflow-x:hidden;
    }

    body::before{
      content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:radial-gradient(circle at 20% 50%,rgba(102,126,234,0.1) 0%,transparent 50%),
                 radial-gradient(circle at 80% 80%,rgba(118,75,162,0.1) 0%,transparent 50%);
      pointer-events:none;z-index:0;
    }

    .wrap{max-width:1100px;margin:0 auto;padding:24px;position:relative;z-index:1;animation:fadeIn 0.6s ease-out}

    /* Header */
    .header{
      display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      padding:20px 28px;margin-bottom:32px;
      background:rgba(255,255,255,0.03);
      backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,0.1);
      border-radius:20px;
      box-shadow:0 8px 32px rgba(0,0,0,0.2);
    }
    .title{
      font-size:28px;font-weight:800;
      background:linear-gradient(135deg,var(--accent-start),var(--accent-end));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      background-clip:text;letter-spacing:0.5px;
    }
    .header-right{display:flex;align-items:center;gap:12px;color:var(--text-muted);font-size:13px}

    .small{font-size:12px;color:var(--text-muted)}
    .stack{display:flex;flex-direction:column;gap:20px}

    /* Modern Cards with Glassmorphism */
    .card{
      background:var(--card-bg);
      backdrop-filter:blur(20px);
      border:1px solid var(--card-border);
      border-radius:20px;
      box-shadow:0 8px 32px rgba(0,0,0,0.3);
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
      overflow:hidden;
      animation:fadeIn 0.6s ease-out backwards;
    }
    .card:hover{
      transform:translateY(-2px);
      box-shadow:0 12px 48px rgba(0,0,0,0.4);
      border-color:rgba(255,255,255,0.2);
    }
    .card-header{
      display:flex;align-items:center;justify-content:space-between;
      padding:20px 24px;cursor:pointer;user-select:none;
      background:rgba(255,255,255,0.02);
      transition:background 0.3s ease;
    }
    .card-header:hover{background:rgba(255,255,255,0.05)}
    .card-title{font-weight:700;margin:0;font-size:16px;letter-spacing:0.3px}
    .chev{
      display:inline-flex;align-items:center;justify-content:center;
      width:28px;height:28px;transition:transform 0.3s cubic-bezier(0.4,0,0.2,1);
      opacity:0.7;
    }
    .card.collapsed .chev{transform:rotate(-90deg)}
    .card-content{padding:0 24px 24px 24px;animation:fadeIn 0.4s ease-out}

    .row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:10px}

    label{
      font-size:12px;color:var(--text-muted);font-weight:600;
      letter-spacing:0.5px;text-transform:uppercase;
    }

    /* Modern Inputs */
    input[type="text"],input[type="email"],input[type="password"],input[type="number"],select,textarea,input[type="month"]{
      width:100%;
      background:var(--input-bg);
      border:1px solid var(--input-border);
      color:var(--text);
      border-radius:14px;
      padding:14px 16px;
      font-size:15px;
      outline:none;
      transition:all 0.3s ease;
      font-family:inherit;
    }
    input[type="text"]:focus,input[type="email"]:focus,input[type="password"]:focus,input[type="number"]:focus,select:focus,textarea:focus,input[type="month"]:focus{
      background:rgba(255,255,255,0.12);
      border-color:var(--accent-start);
      box-shadow:0 0 0 3px var(--accent-glow);
    }
    input::placeholder{color:rgba(255,255,255,0.3)}
    textarea{min-height:88px;resize:vertical}

    /* Modern Buttons */
    .btn{
      border:none;
      background:linear-gradient(135deg,var(--accent-start),var(--accent-end));
      color:white;
      border-radius:14px;
      padding:14px 20px;
      font-weight:600;
      font-size:15px;
      cursor:pointer;
      transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
      position:relative;
      overflow:hidden;
      box-shadow:0 4px 15px rgba(102,126,234,0.3);
    }
    .btn::before{
      content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:linear-gradient(135deg,rgba(255,255,255,0.2),transparent);
      opacity:0;transition:opacity 0.3s ease;
    }
    .btn:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 25px rgba(102,126,234,0.5);
    }
    .btn:hover::before{opacity:1}
    .btn:active{transform:translateY(0)}
    .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}

    .btn.alt{
      background:rgba(255,255,255,0.08);
      color:var(--text);
      border:1px solid rgba(255,255,255,0.15);
      box-shadow:none;
    }
    .btn.alt:hover{
      background:rgba(255,255,255,0.12);
      box-shadow:0 4px 15px rgba(0,0,0,0.2);
    }

    .btn.ghost{
      background:transparent;
      border:1px solid rgba(255,255,255,0.2);
      color:var(--text);
      box-shadow:none;
    }
    .btn.ghost:hover{
      background:rgba(255,255,255,0.05);
      border-color:rgba(255,255,255,0.3);
    }

    .btn.warn{
      background:linear-gradient(135deg,#ef4444,#dc2626);
      box-shadow:0 4px 15px rgba(239,68,68,0.3);
    }
    .btn.warn:hover{box-shadow:0 6px 25px rgba(239,68,68,0.5)}

    .chips{display:flex;gap:10px;flex-wrap:wrap}
    .chip{
      background:rgba(102,126,234,0.15);
      color:var(--text);
      padding:10px 16px;
      border-radius:999px;
      border:1px solid rgba(102,126,234,0.3);
      display:inline-flex;
      align-items:center;
      gap:10px;
      transition:all 0.3s ease;
      font-size:14px;
      font-weight:500;
    }
    .chip:hover{
      background:rgba(102,126,234,0.25);
      border-color:rgba(102,126,234,0.5);
      transform:translateY(-1px);
    }
    .chip .x{cursor:pointer;opacity:0.7;transition:opacity 0.2s ease}
    .chip .x:hover{opacity:1}

    /* Modern Table */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      background:rgba(255,255,255,0.02);
      border-radius:12px;
      overflow:hidden;
    }
    th,td{
      border-bottom:1px solid rgba(255,255,255,0.05);
      padding:14px 12px;
      text-align:left;
      font-size:14px;
    }
    th{
      color:var(--text-muted);
      font-weight:700;
      background:rgba(255,255,255,0.05);
      text-transform:uppercase;
      font-size:12px;
      letter-spacing:0.5px;
    }
    tbody tr{transition:background 0.2s ease}
    tbody tr:hover{background:rgba(255,255,255,0.03)}
    tfoot td{font-weight:700;background:rgba(255,255,255,0.05)}

    .seg{
      display:flex;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.1);
      border-radius:14px;
      overflow:hidden;
      padding:4px;
    }
    .seg button{
      flex:1;
      background:transparent;
      border:0;
      color:var(--text-muted);
      padding:12px 16px;
      font-weight:600;
      border-radius:10px;
      transition:all 0.3s ease;
      cursor:pointer;
    }
    .seg button.active{
      color:var(--text);
      background:linear-gradient(135deg,var(--accent-start),var(--accent-end));
      box-shadow:0 2px 10px var(--accent-glow);
    }

    .pill{
      font-weight:700;
      padding:6px 14px;
      border-radius:999px;
      font-size:13px;
      display:inline-block;
    }
    .pill.ok{background:rgba(16,185,129,0.2);color:#10b981;border:1px solid rgba(16,185,129,0.3)}
    .pill.bad{background:rgba(239,68,68,0.2);color:#ef4444;border:1px solid rgba(239,68,68,0.3)}

    .muted{color:var(--text-muted)}
    .right{margin-left:auto}
    .footer{color:var(--text-muted);text-align:center;margin:32px 0;font-size:14px}
    .note{font-size:13px;color:var(--text-muted);line-height:1.5}
    .big{font-size:24px;font-weight:800;background:linear-gradient(135deg,var(--accent-start),var(--accent-end));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}

    /* Modern Details/Summary */
    details{
      border:1px solid var(--card-border);
      border-radius:16px;
      background:var(--card-bg);
      backdrop-filter:blur(20px);
      padding:16px 20px;
      transition:all 0.3s ease;
    }
    details:hover{border-color:rgba(255,255,255,0.2)}
    summary{
      font-weight:700;
      cursor:pointer;
      list-style:none;
      transition:color 0.3s ease;
    }
    summary:hover{color:var(--accent-start)}
    summary::-webkit-details-marker{display:none}
    .summary-row{display:flex;align-items:center;gap:12px}
    .tag{
      font-size:11px;
      padding:6px 12px;
      border:1px solid rgba(255,255,255,0.2);
      border-radius:999px;
      background:rgba(255,255,255,0.05);
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }

    /* Stagger animation for cards */
    .card:nth-child(1){animation-delay:0s}
    .card:nth-child(2){animation-delay:0.05s}
    .card:nth-child(3){animation-delay:0.1s}
    .card:nth-child(4){animation-delay:0.15s}
    .card:nth-child(5){animation-delay:0.2s}
    .card:nth-child(6){animation-delay:0.25s}
    .card:nth-child(7){animation-delay:0.3s}
    .card:nth-child(8){animation-delay:0.35s}
    .card:nth-child(9){animation-delay:0.4s}
    details{animation:fadeIn 0.6s ease-out 0.1s backwards}
  </style>
<link rel="manifest" href="/family-accounts/manifest.webmanifest?v=3" />
<meta name="theme-color" content="#0f172a" />
<link rel="icon" href="/family-accounts/favicon-32.png" sizes="32x32" />
<link rel="icon" href="/family-accounts/favicon-48.png" sizes="48x48" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/family-accounts/service-worker.js")
        .catch(err => console.error("SW registration failed:", err));
    });
  }
</script>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">üè¶ Family Accounts</div>
      <div class="header-right">
        <span id="modeBadge">Mode: Local storage</span>
        <span>‚Ä¢</span>
        <span>Last edited: <span id="lastEdited">‚Äî</span></span>
      </div>
    </div>

    <div class="stack" style="margin-top:14px">
      <div class="card" data-section="auth">
        <div class="card-header"><div class="card-title">Supabase account</div><div class="chev">‚ñ∏</div></div>
        <div class="card-content">
          <div id="authMessage" style="display:none;padding:12px;border-radius:12px;margin-bottom:12px"></div>
          <div class="row">
            <div class="col" style="flex:1;min-width:220px">
              <label for="authEmail">Email</label>
              <input id="authEmail" type="email" autocomplete="email" placeholder="you@example.com" />
            </div>
            <div class="col" style="flex:1;min-width:220px">
              <label for="authPassword">Password</label>
              <input id="authPassword" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
          </div>
          <div class="row">
            <button class="btn" id="signInBtn" type="button">Sign in</button>
            <button class="btn alt" id="signUpBtn" type="button">Sign up</button>
            <button class="btn ghost" id="forgotPasswordBtn" type="button">Forgot password</button>
            <button class="btn ghost" id="signOutBtn" type="button">Sign out</button>
          </div>
          <div class="note" id="authStatus">Not signed in.</div>
          <div class="note" style="margin-top:8px">Sign up requires email confirmation (min. 6 characters password). Your data syncs to Supabase when signed in.</div>
        </div>
      </div>

      <details>
        <summary>
          <div class="summary-row">
            <span>Import / export</span>
            <span class="tag" id="fileStatus">Local-only (not signed in)</span>
          </div>
        </summary>
        <div class="row" style="margin-top:8px">
          <button class="btn alt" id="importBtn" type="button">Import JSON (backup)</button>
          <input type="file" id="importInput" accept="application/json" style="display:none" />
          <button class="btn alt" id="exportBtn" type="button">Export JSON (backup)</button>
        </div>
        <div class="note">Importing a backup will merge all months into your current storage mode.</div>
      </details>

      <!-- NEW: Month picker in its own box -->
      <div class="card" data-section="month">
        <div class="card-header"><div class="card-title">Month</div><div class="chev">‚ñ∏</div></div>
        <div class="card-content">
          <div class="col" style="max-width:220px">
            <label for="month">Select month</label>
            <input type="month" id="month" />
          </div>
        </div>
      </div>

      <div class="card" data-section="people">
        <div class="card-header"><div class="card-title">People</div><div class="chev">‚ñ∏</div></div>
        <div class="card-content">
          <div class="row">
            <input id="personName" type="text" placeholder="e.g., Stuart" inputmode="text" autocomplete="off" />
            <button class="btn" id="addPersonBtn" type="button">Add person</button>
          </div>
          <div class="chips" id="peopleChips"></div>
        </div>
      </div>

      <div class="card" data-section="categories">
        <div class="card-header"><div class="card-title">Categories</div><div class="chev">‚ñ∏</div></div>
        <div class="card-content">
          <div class="row">
            <input id="categoryName" type="text" placeholder="e.g., Groceries" />
            <button class="btn" id="addCategoryBtn" type="button">Add category</button>
          </div>
          <div class="chips" id="categoriesChips"></div>
        </div>
      </div>

      <div class="card" data-section="add-expenses">
        <div class="card-header"><div class="card-title">Add expenses</div><div class="chev">‚ñ∏</div></div>
        <div class="card-content">
          <div class="seg" style="margin-bottom:10px">
            <button id="modeQuick" class="active" type="button">Quick add (same category)</button>
            <button id="modeBatch" type="button">Batch add (multiple categories)</button>
          </div>

          <div id="quickPanel">
            <div class="row">
              <div class="col" style="min-width:160px;flex:1">
                <label>Payer</label>
                <select id="quickPerson"></select>
              </div>
              <div class="col" style="min-width:160px;flex:1">
                <label>Category</label>
                <select id="quickCategory"></select>
              </div>
              <div class="col" style="min-width:180px;flex:1">
                <label>Split</label>
                <select id="quickSplit"></select>
              </div>
            </div>
            <div class="row">
              <div class="col" style="flex:1">
                <label>Amounts (comma / space / new line separated)</label>
                <textarea id="quickAmounts" placeholder="e.g., 12.50, 7, 19.99"></textarea>
                <div class="note">Tip: paste many numbers, one per line. Both "," and "." work as decimals.</div>
              </div>
            </div>
            <div class="row">
              <div class="col" style="flex:1">
                <label>Note (optional, applied to all)</label>
                <input id="quickNote" type="text" placeholder="e.g., supermarket run" />
              </div>
            </div>
            <div class="row">
              <button class="btn" id="addQuickBtn" type="button">Add expense(s)</button>
              <button class="btn ghost" id="clearQuickBtn" type="button">Clear</button>
            </div>
          </div>

          <div id="batchPanel" style="display:none">
            <div class="row">
              <div class="col" style="min-width:160px;flex:1">
                <label>Payer</label>
                <select id="batchPerson"></select>
              </div>
              <div class="col" style="min-width:180px;flex:1">
                <label>Split</label>
                <select id="batchSplit"></select>
              </div>
            </div>
            <div id="batchRows"></div>
            <div class="row">
              <button class="btn alt" id="addBatchRowBtn" type="button">+ Add another line</button>
              <div class="right"></div>
              <button class="btn" id="saveBatchBtn" type="button">Save all lines</button>
              <button class="btn ghost" id="clearBatchBtn" type="button">Clear lines</button>
            </div>
            <div class="note">Each line: choose a category and enter amount. Split applies to all lines here.</div>
          </div>
        </div>
      </div>

      <div class="card" data-section="all-expenses">
        <div class="card-header">
          <div class="card-title">All expenses</div>
          <div class="row">
            <button class="btn warn" id="clearMonthBtn" type="button">Clear this month‚Äôs expenses</button>
            <div class="chev">‚ñ∏</div>
          </div>
        </div>
        <div class="card-content">
          <div class="row" style="justify-content:space-between">
            <div class="muted">Tap üóëÔ∏è to remove a line</div>
          </div>
          <div id="expensesEmpty" class="muted" style="padding:6px 0 12px">No expenses yet.</div>
          <div style="overflow:auto">
            <table id="expensesTable" style="display:none">
              <thead>
                <tr><th>#</th><th>Payer</th><th>Category</th><th>Note</th><th>Amount</th><th>Split</th><th></th></tr>
              </thead>
              <tbody id="expensesBody"></tbody>
              <tfoot>
                <tr><td colspan="4">Total</td><td id="totalCell">‚Ç¨0.00</td><td></td><td></td></tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <div class="card" data-section="totals-people">
        <div class="card-header"><div class="card-title">Totals by person</div><div class="chev">‚ñ∏</div></div>
        <div class="card-content"><div id="totalsPeople"></div></div>
      </div>

      <div class="card" data-section="totals-categories">
        <div class="card-header"><div class="card-title">Totals by category</div><div class="chev">‚ñ∏</div></div>
        <div class="card-content"><div id="totalsCategories"></div></div>
      </div>

      <div class="card" data-section="settlements">
        <div class="card-header"><div class="card-title">Who owes who</div><div class="chev">‚ñ∏</div></div>
        <div class="card-content">
          <div id="settlements"></div>
          <div class="note">Balances are based on what each person paid minus what they owed from the chosen splits. Positive balances mean others owe them; negative balances mean they owe others.</div>
        </div>
      </div>

      <div class="card" data-section="averages">
        <div class="card-header"><div class="card-title">Averages</div><div class="chev">‚ñ∏</div></div>
        <div class="card-content">
          <div class="row">
            <div class="col">
              <label>Average monthly spend ‚Äî YTD</label>
              <div id="avgYTD" class="big">‚Ç¨0.00</div>
            </div>
            <div class="col">
              <label>Average monthly spend ‚Äî All saved months</label>
              <div id="avgAll" class="big">‚Ç¨0.00</div>
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <div class="col" style="flex:1">
              <div class="card-title" style="font-weight:700">Average by category ‚Äî YTD</div>
              <div id="avgCatYTD"></div>
            </div>
            <div class="col" style="flex:1">
              <div class="card-title" style="font-weight:700">Average by category ‚Äî All</div>
              <div id="avgCatAll"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="footer">stuartscottAI</div>
    </div>
  </div>

  <script>
    // ---------- Core selectors ----------
    const monthEl = document.getElementById('month');
    const modeBadge = document.getElementById('modeBadge');
    const lastEditedEl = document.getElementById('lastEdited');

    const personNameEl = document.getElementById('personName');
    const addPersonBtn = document.getElementById('addPersonBtn');
    const peopleChips = document.getElementById('peopleChips');

    const categoryNameEl = document.getElementById('categoryName');
    const addCategoryBtn = document.getElementById('addCategoryBtn');
    const categoriesChips = document.getElementById('categoriesChips');

    const modeQuickBtn = document.getElementById('modeQuick');
    const modeBatchBtn = document.getElementById('modeBatch');
    const quickPanel = document.getElementById('quickPanel');
    const batchPanel = document.getElementById('batchPanel');

    const quickPerson = document.getElementById('quickPerson');
    theQuickCategory = document.getElementById('quickCategory'); // keep old id name; variable name typo fixed below
    const quickCategory = document.getElementById('quickCategory');
    const quickSplit = document.getElementById('quickSplit');
    const quickAmounts = document.getElementById('quickAmounts');
    const addQuickBtn = document.getElementById('addQuickBtn');
    const clearQuickBtn = document.getElementById('clearQuickBtn');

    const batchPerson = document.getElementById('batchPerson');
    const batchSplit = document.getElementById('batchSplit');
    const batchRows = document.getElementById('batchRows');
    const addBatchRowBtn = document.getElementById('addBatchRowBtn');
    const saveBatchBtn = document.getElementById('saveBatchBtn');
    const clearBatchBtn = document.getElementById('clearBatchBtn');

    const expensesEmpty = document.getElementById('expensesEmpty');
    const expensesTable = document.getElementById('expensesTable');
    const expensesBody = document.getElementById('expensesBody');
    const totalCell = document.getElementById('totalCell');

    const totalsPeople = document.getElementById('totalsPeople');
    const totalsCategories = document.getElementById('totalsCategories');
    const settlements = document.getElementById('settlements');

    const clearMonthBtn = document.getElementById('clearMonthBtn');

    // Averages
    const avgYTD = document.getElementById('avgYTD');
    const avgAll = document.getElementById('avgAll');
    const avgCatYTD = document.getElementById('avgCatYTD');
    const avgCatAll = document.getElementById('avgCatAll');

    // Auth selectors
    const authEmail = document.getElementById('authEmail');
    const authPassword = document.getElementById('authPassword');
    const signInBtn = document.getElementById('signInBtn');
    const signUpBtn = document.getElementById('signUpBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
    const authStatus = document.getElementById('authStatus');
    const authMessage = document.getElementById('authMessage');

    // Import/export selectors
    const fileStatus = document.getElementById('fileStatus');
    const importBtn = document.getElementById('importBtn');
    const exportBtn = document.getElementById('exportBtn');
    const importInput = document.getElementById('importInput');

    // ---------- App state ----------
    let data = null; // current month data (only expenses and lastEdited)
    let fileData = { people: [], categories: [], months: {} }; // Global people/categories + months
    let saveDebounce = null;
    let lastLoadedMonth = null;
    let supabaseClient = null;
    let currentUser = null;

    // ---------- Supabase config ----------
    //
    // SETUP INSTRUCTIONS:
    // 1. Go to https://supabase.com and create a free account
    // 2. Create a new project (choose a region close to you)
    // 3. Once created, go to Project Settings > API
    // 4. Copy the "Project URL" and replace SUPABASE_URL below
    // 5. Copy the "anon public" key and replace SUPABASE_ANON_KEY below
    // 6. Go to SQL Editor and run this SQL to create the required table:
    //
    //    CREATE TABLE family_account_data (
    //      user_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    //      data JSONB NOT NULL DEFAULT '{"months": {}}'::jsonb,
    //      updated_at TIMESTAMPTZ DEFAULT NOW()
    //    );
    //
    //    -- Enable Row Level Security
    //    ALTER TABLE family_account_data ENABLE ROW LEVEL SECURITY;
    //
    //    -- Policy: Users can only access their own data
    //    CREATE POLICY "Users can manage their own data"
    //      ON family_account_data
    //      FOR ALL
    //      USING (auth.uid() = user_id)
    //      WITH CHECK (auth.uid() = user_id);
    //
    // 7. Go to Authentication > Settings and configure:
    //    - Enable "Email confirmations" (recommended)
    //    - Set "Site URL" to your app's URL
    //    - Configure email templates if desired
    //
    const SUPABASE_URL = 'https://huxaxrxoacmvtdmxkpsr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1eGF4cnhvYWNtdnRkbXhrcHNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0MTc0OTEsImV4cCI6MjA4MTk5MzQ5MX0.HsG-Q20d3uT5kldXDeJFt6aJmXfxX_S7XWCj9iovRnw';

    // ---------- Utilities ----------
    function thisMonthValue(){
      const d = new Date();
      const m = String(d.getMonth()+1).padStart(2,'0');
      return `${d.getFullYear()}-${m}`;
    }
    function keyFor(month){ return `famacct:${month}` }
    function defaultData(){
      return {expenses:[], lastEdited: new Date().toISOString()};
    }
    function euro(n){ return n.toLocaleString('es-ES',{style:'currency',currency:'EUR'}) }
    function round2(n){ return Math.round((n+Number.EPSILON)*100)/100 }
    function debounceSave(){ clearTimeout(saveDebounce); saveDebounce = setTimeout(()=>persist(), 400); }
    function setModeBadge(){
      if(currentUser){
        modeBadge.textContent = `Mode: Supabase ‚Äî ${currentUser.email}`;
        return;
      }
      modeBadge.textContent = 'Mode: Local storage (not signed in)';
    }
    function formatUK(iso){
      if(!iso) return '‚Äî';
      const d = new Date(iso);
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      const HH = String(d.getHours()).padStart(2,'0');
      const min = String(d.getMinutes()).padStart(2,'0');
      return `${dd}/${mm}/${yyyy} ${HH}:${min}`;
    }
    function setLastEditedNow(){ if(data){ data.lastEdited = new Date().toISOString(); renderLastEdited(); } }
    function renderLastEdited(){ lastEditedEl.textContent = formatUK(data?.lastEdited); }

    // ---------- Auth utilities ----------
    function showAuthMessage(message, type = 'info'){
      // type: 'success', 'error', 'info'
      authMessage.textContent = message;
      authMessage.style.display = 'block';
      if(type === 'success'){
        authMessage.style.background = '#ecfdf5';
        authMessage.style.color = '#065f46';
        authMessage.style.border = '1px solid #6ee7b7';
      } else if(type === 'error'){
        authMessage.style.background = '#fef2f2';
        authMessage.style.color = '#7f1d1d';
        authMessage.style.border = '1px solid #fca5a5';
      } else {
        authMessage.style.background = '#eff6ff';
        authMessage.style.color = '#1e3a8a';
        authMessage.style.border = '1px solid #bfdbfe';
      }
      // Auto-hide after 8 seconds for success/info messages
      if(type !== 'error'){
        setTimeout(() => { authMessage.style.display = 'none'; }, 8000);
      }
    }
    function hideAuthMessage(){ authMessage.style.display = 'none'; }
    function validateEmail(email){
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }
    function validatePassword(password){
      return password && password.length >= 6;
    }
    function setButtonLoading(button, isLoading){
      if(isLoading){
        button.disabled = true;
        button.dataset.originalText = button.textContent;
        button.textContent = '‚è≥ Loading...';
      } else {
        button.disabled = false;
        if(button.dataset.originalText){
          button.textContent = button.dataset.originalText;
          delete button.dataset.originalText;
        }
      }
    }

    // ---------- Collapsible cards ----------
    const COLLAPSE_KEY = 'famacct:collapsed';
    function loadCollapsed(){ try{ return JSON.parse(localStorage.getItem(COLLAPSE_KEY)||'{}'); }catch{return {}}; }
    function saveCollapsed(obj){ try{ localStorage.setItem(COLLAPSE_KEY, JSON.stringify(obj)); }catch{} }
    function setupCollapsibles(){
      const state = loadCollapsed();
      document.querySelectorAll('.card[data-section]').forEach(card=>{
        const key = card.getAttribute('data-section');
        const header = card.querySelector('.card-header');
        const content = card.querySelector('.card-content');
        const collapsed = !!state[key];
        if(collapsed){ card.classList.add('collapsed'); content.style.display = 'none'; }
        header.addEventListener('click', (e)=>{
          if(e.target.closest('button')) return; // don‚Äôt collapse when clicking a button inside header
          const now = card.classList.toggle('collapsed');
          content.style.display = now ? 'none' : 'block';
          const st = loadCollapsed(); st[key] = now ? 1 : 0; saveCollapsed(st);
        });
      });
    }

    // ---------- Storage: Local ----------
    function localLoadMonth(month){
      const raw = localStorage.getItem(keyFor(month));
      if(raw){
        try{
          const parsed = JSON.parse(raw);
          // Migrate old format: extract people/categories if they exist
          if(parsed.people || parsed.categories){
            // Merge into global lists
            if(parsed.people){
              fileData.people = Array.from(new Set([...(fileData.people||[]), ...(parsed.people||[])]));
            }
            if(parsed.categories){
              fileData.categories = Array.from(new Set([...(fileData.categories||[]), ...(parsed.categories||[])]));
            }
            // Save migrated data
            saveGlobalToLocal();
          }
          // Only keep expenses and lastEdited for month data
          data = {
            expenses: parsed.expenses || [],
            lastEdited: parsed.lastEdited || new Date().toISOString()
          };
        }catch{
          data = defaultData();
        }
        if(!data.lastEdited){ data.lastEdited = new Date().toISOString(); }
      } else {
        data = defaultData();
        localStorage.setItem(keyFor(month), JSON.stringify(data));
      }
    }
    function localSaveCurrent(){
      // Only save expenses and lastEdited for each month
      localStorage.setItem(keyFor(monthEl.value), JSON.stringify(data));
    }
    function saveGlobalToLocal(){
      // Save global people and categories
      try{
        localStorage.setItem('famacct:global', JSON.stringify({
          people: fileData.people || [],
          categories: fileData.categories || []
        }));
      }catch(e){
        console.error('Failed to save global data', e);
      }
    }
    function loadGlobalFromLocal(){
      // Load global people and categories
      try{
        const raw = localStorage.getItem('famacct:global');
        if(raw){
          const global = JSON.parse(raw);
          fileData.people = global.people || [];
          fileData.categories = global.categories || [];
        } else {
          // No global data exists yet - migrate from all saved months
          console.log('Migrating people and categories from all saved months...');
          const allPeople = new Set();
          const allCategories = new Set();

          // Scan all saved months and extract people/categories
          for(let i=0; i<localStorage.length; i++){
            const key = localStorage.key(i);
            if(key && key.startsWith('famacct:') && key !== 'famacct:global' && key !== 'famacct:collapsed'){
              try{
                const monthData = JSON.parse(localStorage.getItem(key));
                if(monthData.people && Array.isArray(monthData.people)){
                  monthData.people.forEach(p => allPeople.add(String(p).trim()));
                }
                if(monthData.categories && Array.isArray(monthData.categories)){
                  monthData.categories.forEach(c => allCategories.add(String(c).trim()));
                }
              }catch(e){
                console.error('Failed to parse month data for migration:', key, e);
              }
            }
          }

          fileData.people = Array.from(allPeople).filter(Boolean);
          fileData.categories = Array.from(allCategories).filter(Boolean);

          // Save the migrated global data
          if(fileData.people.length > 0 || fileData.categories.length > 0){
            console.log('Migrated', fileData.people.length, 'people and', fileData.categories.length, 'categories');
            saveGlobalToLocal();
          }
        }
      }catch(e){
        console.error('Failed to load global data', e);
      }
    }
    function listSavedMonthsLocal(){
      const months = [];
      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(k && k.startsWith('famacct:')) months.push(k.split(':')[1]);
      }
      months.sort((a,b)=> a<b?1:(a>b?-1:0));
      return months;
    }

    function listSavedMonthsRemote(){ return Object.keys(fileData.months||{}).sort((a,b)=> a<b?1:(a>b?-1:0)); }

    // ---------- Shared load/save ----------
    function monthExists(month){
      if(currentUser) return !!(fileData.months && fileData.months[month]);
      return localStorage.getItem(keyFor(month)) != null;
    }

    async function loadFromFileOrLocal(month){
      if(currentUser){
        data = fileData.months[month];
        if(!data){
          const localRaw = localStorage.getItem(keyFor(month));
          if(localRaw){
            try{
              const parsed = JSON.parse(localRaw);
              // Only keep expenses and lastEdited
              data = {
                expenses: parsed.expenses || [],
                lastEdited: parsed.lastEdited || new Date().toISOString()
              };
            }catch{
              data = defaultData();
            }
          } else {
            data = defaultData();
          }
        }
      } else {
        localLoadMonth(month);
      }
    }

    function persist(){
      try{ localSaveCurrent(); }catch{}
      if(currentUser){
        fileData.months[monthEl.value] = data;
        saveRemote().catch(err=>{
          console.error(err);
          fileStatus.textContent = 'Supabase save failed (working locally)';
        });
      } else {
        saveGlobalToLocal();
      }
      renderAverages();
    }

    // ---------- Helpers ----------
    function uniqueList(arr){ return Array.from(new Set((arr||[]).map(s=>String(s).trim()).filter(Boolean))); }

    // ---------- Split helpers ----------
    function buildSplitOptions(selectEl){
      const ppl = fileData.people || [];
      selectEl.innerHTML='';
      if(ppl.length === 2){
        const [a,b] = ppl;
        [[`50_50`,`50/50`],[`100_${a}`,`${a} 100%`],[`100_${b}`,`${b} 100%`]].forEach(([v,l])=>{
          const o=document.createElement('option'); o.value=v; o.textContent=l; selectEl.appendChild(o);
        });
      } else {
        const o1=document.createElement('option'); o1.value='equal_all'; o1.textContent='Equal among all people'; selectEl.appendChild(o1);
        const o2=document.createElement('option'); o2.value='payer_100'; o2.textContent='Payer 100%'; selectEl.appendChild(o2);
      }
    }
    function computeSplitsFromChoice(choice, payer){
      const ppl = fileData.people || [];
      const splits = {};
      if(ppl.length === 2){
        const [a,b] = ppl;
        if(choice==='50_50'){ splits[a]=50; splits[b]=50; }
        else if(choice===`100_${a}`){ splits[a]=100; splits[b]=0; }
        else if(choice===`100_${b}`){ splits[a]=0; splits[b]=100; }
        else { splits[a]=50; splits[b]=50; }
      } else {
        if(choice==='payer_100' && payer){ ppl.forEach(p=>splits[p]= (p===payer?100:0)); }
        else { // equal_all
          const share = Math.floor(100/ppl.length);
          let sum=0; for(let i=0;i<ppl.length;i++){ splits[ppl[i]] = (i===ppl.length-1) ? 100-sum : share; sum+=share; }
        }
      }
      return splits;
    }
    function splitsToLabel(splits){
      const parts = Object.entries(splits||{}).filter(([_,v])=>v>0).map(([k,v])=>`${k} ${v}%`);
      return parts.join(' / ') || '‚Äî';
    }

    // ---------- Computations & Rendering ----------
    // CHANGED: computeTotals now shows what each person ACTUALLY PAID (sum by payer), not split shares
    function computeTotals(){
      const perPerson = Object.fromEntries((fileData.people||[]).map(p=>[p,0]));
      const perCategory = Object.fromEntries((fileData.categories||[]).map(c=>[c,0]));
      let grand=0;
      for(const e of (data.expenses||[])){
        const amount = +e.amount || 0;
        const payer = e.payer || e.person || '';
        if(!(payer in perPerson)) perPerson[payer]=0;
        perPerson[payer] = round2((perPerson[payer]||0) + amount);
        if(!(e.category in perCategory)) perCategory[e.category]=0;
        perCategory[e.category]+= amount;
        grand+= amount;
      }
      perPerson.__total = round2(grand);
      return {perPerson, perCategory};
    }

    // CHANGED: computeSettlements uses PAID vs OWED (OWED from splits), not equal-share-of-grand-total
    function computeSettlements(){
      const people = (fileData.people||[]);
      const paid = Object.fromEntries(people.map(p=>[p,0]));
      const owed = Object.fromEntries(people.map(p=>[p,0]));
      let grand = 0;

      for(const e of (data.expenses||[])){
        const amount = +e.amount || 0;
        const payer = e.payer || e.person || '';
        grand += amount;

        // what was actually paid
        if(!(payer in paid)) paid[payer]=0;
        paid[payer] = round2((paid[payer]||0) + amount);

        // liability owed according to splits
        const splits = e.splits || {[payer]:100};
        const entries = Object.entries(splits);
        let allocated = 0;
        entries.forEach(([p, pct], idx) => {
          if(!(p in owed)) owed[p]=0;
          let part = round2(amount * ((+pct || 0)/100));
          allocated = round2(allocated + part);
          if(idx === entries.length - 1){
            const remainder = round2(amount - allocated);
            part = round2(part + remainder);
          }
          owed[p] = round2((owed[p]||0) + part);
        });
      }

      const balances = people.map(p=>({ person:p, balance: round2((paid[p]||0) - (owed[p]||0)) }));

      // greedy settlement: debtors (negative) pay creditors (positive)
      const creditors = balances.filter(b=>b.balance>0).map(b=>({...b})).sort((a,b)=>b.balance-a.balance);
      const debtors = balances.filter(b=>b.balance<0).map(b=>({...b})).sort((a,b)=>a.balance-b.balance);
      const transfers = [];
      let ci=0, di=0;
      while(ci<creditors.length && di<debtors.length){
        const c = creditors[ci], d = debtors[di];
        const amt = round2(Math.min(c.balance, -d.balance));
        if(amt>0){
          transfers.push({from:d.person,to:c.person,amount:amt});
          c.balance = round2(c.balance - amt);
          d.balance = round2(d.balance + amt);
        }
        if(c.balance<=0.0001) ci++;
        if(d.balance>=-0.0001) di++;
      }
      // Share kept ONLY for existing UI display; not used in balance math
      const n = people.length || 1;
      const share = round2((grand||0)/n);
      return {share, balances, transfers};
    }

    function renderPeopleCats(){
      peopleChips.innerHTML = '';
      for(const p of (fileData.people||[])){
        const c = document.createElement('span');
        c.className='chip';
        c.innerHTML = '<span>'+p+'</span><span class="x" title="Remove">‚úñ</span>';
        c.querySelector('.x').addEventListener('click',()=>{ if(confirm('Remove '+p+' and their expenses from ALL months?')) { removePerson(p); }});
        peopleChips.appendChild(c);
      }
      categoriesChips.innerHTML = '';
      for(const cName of (fileData.categories||[])){
        const c = document.createElement('span');
        c.className='chip';
        c.innerHTML = '<span>'+cName+'</span><span class="x" title="Remove">‚úñ</span>';
        c.querySelector('.x').addEventListener('click',()=>{ if(confirm('Remove category \"'+cName+'\" from ALL months?')) { removeCategory(cName); }});
        categoriesChips.appendChild(c);
      }
      fillSelect(quickPerson, (fileData.people||[]));
      fillSelect(quickCategory, (fileData.categories||[]));
      fillSelect(batchPerson, (fileData.people||[]));
      buildSplitOptions(quickSplit);
      buildSplitOptions(batchSplit);
      [...batchRows.querySelectorAll('.batchCategory')].forEach(sel=>fillSelect(sel, (fileData.categories||[])));
    }
    function renderExpenses(){
      if(!(data.expenses||[]).length){
        expensesEmpty.style.display='block';
        expensesTable.style.display='none';
        totalCell.textContent = euro(0);
        expensesBody.innerHTML = '';
        return;
      }
      expensesEmpty.style.display='none';
      expensesTable.style.display='table';
      expensesBody.innerHTML = '';
      let i=1, total=0;
      for(const [idx,e] of (data.expenses||[]).entries()){
        total += (+e.amount||0);
        const tr = document.createElement('tr');
        const payer = e.payer || e.person || '';
        const splitTxt = splitsToLabel(e.splits||{[payer]:100});
        tr.innerHTML = '<td>'+ (i++) +'</td><td>'+payer+'</td><td>'+e.category+'</td><td>'+(e.note?String(e.note).replace(/</g,'&lt;'):'')+'</td><td>'+euro(+e.amount||0)+'</td><td>'+splitTxt+'</td><td><button class="btn ghost" title="Delete" data-i="'+idx+'" type="button">üóëÔ∏è</button></td>';
        tr.querySelector('button').addEventListener('click',()=>{ (data.expenses||[]).splice(idx,1); save(); renderAll(); });
        expensesBody.appendChild(tr);
      }
      totalCell.textContent = euro(round2(total));
    }
    function renderTotals(){
      const {perPerson, perCategory} = computeTotals();
      const total = perPerson.__total || 0;
      let htmlP='';
      if((fileData.people||[]).length){
        htmlP += '<table><thead><tr><th>Person</th><th>Total paid this month</th></tr></thead><tbody>';
        for(const p of (fileData.people||[])){
          htmlP += '<tr><td>'+p+'</td><td>'+euro(round2(perPerson[p]||0))+'</td></tr>';
        }
        htmlP += '</tbody><tfoot><tr><td>All people</td><td>'+euro(round2(total))+'</td></tr></tfoot></table>';
      } else htmlP = '<div class="muted">Add some people to see totals.</div>';
      totalsPeople.innerHTML = htmlP;

      let htmlC='';
      if((fileData.categories||[]).length){
        htmlC += '<table><thead><tr><th>Category</th><th>Total</th></tr></thead><tbody>';
        for(const c of (fileData.categories||[])){
          htmlC += '<tr><td>'+c+'</td><td>'+euro(round2(perCategory[c]||0))+'</td></tr>';
        }
        htmlC += '</tbody><tfoot><tr><td>All categories</td><td>'+euro(round2(total))+'</td></tr></tfoot></table>';
      } else htmlC = '<div class="muted">Add some categories to see totals.</div>';
      totalsCategories.innerHTML = htmlC;
    }
    function renderSettlements(){
      const {share, balances, transfers} = computeSettlements();
      if(!(fileData.people||[]).length){ settlements.innerHTML = '<div class="muted">Add people first.</div>'; return; }
      let html = '<div class="row"><div>Equal share per person (based on splits): <strong>'+euro(share)+'</strong></div></div>';
      html += '<table><thead><tr><th>Person</th><th>Balance (positive = others owe them, negative = they owe others)</th></tr></thead><tbody>';
      for(const b of balances){
        const cls = b.balance>=0? 'ok' : 'bad';
        html += '<tr><td>'+b.person+'</td><td><span class="pill '+cls+'">'+(b.balance>=0?'+':'')+euro(b.balance)+'</span></td></tr>';
      }
      html += '</tbody></table>';
      if(!transfers.length){ html += '<div class="muted">No transfers needed ‚úÖ</div>'; }
      else{
        html += '<div class="card-title" style="margin:8px 0">Suggested transfers</div>';
        html += '<table><thead><tr><th>From</th><th>To</th><th>Amount</th></tr></thead><tbody>';
        for(const t of transfers){ html += '<tr><td>'+t.from+'</td><td>'+t.to+'</td><td>'+euro(t.amount)+'</td></tr>'; }
        html += '</tbody></table>';
      }
      settlements.innerHTML = html;
    }
    function renderAll(){
      renderPeopleCats(); renderExpenses(); renderTotals(); renderSettlements(); renderLastEdited();
    }

    function fillSelect(selectEl, items){
      selectEl.innerHTML = '';
      const opt = document.createElement('option'); opt.value=''; opt.textContent='‚Äî select ‚Äî'; selectEl.appendChild(opt);
      for(const it of (items||[])){ const o = document.createElement('option'); o.value=it; o.textContent=it; selectEl.appendChild(o); }
    }

    // Averages across months (from local or file)
    function listSavedMonths(){ return currentUser ? listSavedMonthsRemote() : listSavedMonthsLocal(); }
    function getMonthData(m){
      if(currentUser) return fileData.months[m] || defaultData(null);
      const raw = localStorage.getItem(keyFor(m)); if(!raw) return defaultData(null);
      try{ return JSON.parse(raw); }catch{return defaultData(null);} }
    function computeAverages(){
      const months = listSavedMonths();
      const allData = months.map(m=>({m, d:getMonthData(m)})).filter(x=>x.d);
      const year = new Date().getFullYear();
      const ytd = allData.filter(x => x.m.startsWith(year + '-'));
      const allMonthsCount = allData.length, ytdMonthsCount = ytd.length;
      const sumTotal = (arr)=> arr.reduce((s,x)=> s + (x.d.expenses||[]).reduce((a,e)=>a+(+e.amount||0),0), 0);
      const totalAll = sumTotal(allData), totalYTD = sumTotal(ytd);
      const avgAllVal = allMonthsCount ? round2(totalAll / allMonthsCount) : 0;
      const avgYTDVal = ytdMonthsCount ? round2(totalYTD / ytdMonthsCount) : 0;
      const catsAllTotals = {}, catsYtdTotals = {}; const catSetAll = new Set(), catSetYTD = new Set();
      allData.forEach(({d})=>{ (d.categories||[]).forEach(c=>catSetAll.add(c)); (d.expenses||[]).forEach(e=>{ catsAllTotals[e.category]=(catsAllTotals[e.category]||0)+(+e.amount||0); }); });
      ytd.forEach(({d})=>{ (d.categories||[]).forEach(c=>catSetYTD.add(c)); (d.expenses||[]).forEach(e=>{ catsYtdTotals[e.category]=(catsYtdTotals[e.category]||0)+(+e.amount||0); }); });
      const avgCatAllMap = {}, avgCatYTDMap = {};
      for(const c of catSetAll){ avgCatAllMap[c] = allMonthsCount ? round2((catsAllTotals[c]||0)/allMonthsCount) : 0; }
      for(const c of catSetYTD){ avgCatYTDMap[c] = ytdMonthsCount ? round2((catsYtdTotals[c]||0)/ytdMonthsCount) : 0; }
      return {avgAllVal, avgYTDVal, avgCatAllMap, avgCatYTDMap, allMonthsCount, ytdMonthsCount};
    }
    function tableFromMap(mapObj, leftHeader, rightHeader){
      const keys = Object.keys(mapObj).sort((a,b)=> mapObj[b]-mapObj[a]); if(!keys.length) return '<div class="muted">No data yet.</div>';
      let html = '<table><thead><tr><th>'+leftHeader+'</th><th>'+rightHeader+'</th></tr></thead><tbody>';
      for(const k of keys){ html += '<tr><td>'+k+'</td><td>'+euro(mapObj[k])+'</td></tr>'; }
      html += '</tbody></table>'; return html;
    }
    function renderAverages(){
      const {avgAllVal, avgYTDVal, avgCatAllMap, avgCatYTDMap, allMonthsCount, ytdMonthsCount} = computeAverages();
      avgAll.textContent = euro(avgAllVal) + (allMonthsCount?(' ('+allMonthsCount+' mo.)'):'');
      avgYTD.textContent = euro(avgYTDVal) + (ytdMonthsCount?(' ('+ytdMonthsCount+' mo. YTD)'):'');
      avgCatAll.innerHTML = tableFromMap(avgCatAllMap, 'Category', 'Avg / month (All)');
      avgCatYTD.innerHTML = tableFromMap(avgCatYTDMap, 'Category', 'Avg / month (YTD)');
    }

    // ---------- Supabase ----------
    function initSupabase(){
      if(!window.supabase || !SUPABASE_URL || !SUPABASE_ANON_KEY){
        console.warn('Supabase client not configured.');
        return;
      }
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    async function loadRemote(){
      if(!supabaseClient || !currentUser) return;
      const { data: rows, error } = await supabaseClient
        .from('family_account_data')
        .select('data')
        .eq('user_id', currentUser.id)
        .limit(1);
      if(error){
        console.error(error);
        return;
      }
      if(rows && rows.length){
        fileData = rows[0].data || { people: [], categories: [], months: {} };
        // Ensure people and categories arrays exist
        if(!fileData.people) fileData.people = [];
        if(!fileData.categories) fileData.categories = [];

        // If Supabase data is missing people/categories, try to migrate from localStorage
        if(fileData.people.length === 0 && fileData.categories.length === 0){
          console.log('Supabase data missing people/categories - checking localStorage for migration...');
          const allPeople = new Set();
          const allCategories = new Set();

          // Scan localStorage for existing month data
          for(let i=0; i<localStorage.length; i++){
            const key = localStorage.key(i);
            if(key && key.startsWith('famacct:') && key !== 'famacct:global' && key !== 'famacct:collapsed'){
              try{
                const monthData = JSON.parse(localStorage.getItem(key));
                if(monthData.people && Array.isArray(monthData.people)){
                  monthData.people.forEach(p => allPeople.add(String(p).trim()));
                }
                if(monthData.categories && Array.isArray(monthData.categories)){
                  monthData.categories.forEach(c => allCategories.add(String(c).trim()));
                }
              }catch(e){
                console.error('Failed to parse month data for migration:', key, e);
              }
            }
          }

          if(allPeople.size > 0 || allCategories.size > 0){
            fileData.people = Array.from(allPeople).filter(Boolean);
            fileData.categories = Array.from(allCategories).filter(Boolean);
            console.log('Migrated from localStorage:', fileData.people.length, 'people and', fileData.categories.length, 'categories');
            // Save to Supabase
            await saveRemote();
          }
        }
      } else {
        fileData = { people: [], categories: [], months: {} };
        await saveRemote();
      }
    }

    async function saveRemote(){
      if(!supabaseClient || !currentUser) return;
      const payload = {
        user_id: currentUser.id,
        data: fileData,
        updated_at: new Date().toISOString()
      };
      const { error } = await supabaseClient
        .from('family_account_data')
        .upsert(payload, { onConflict: 'user_id' });
      if(error) throw error;
    }

    async function refreshSession(){
      if(!supabaseClient) return;
      const { data: sessionData } = await supabaseClient.auth.getSession();
      currentUser = sessionData?.session?.user || null;
      setModeBadge();
    }

    function updateFileStatus(){
      if(currentUser){
        fileStatus.textContent = 'Supabase storage';
        authStatus.textContent = `Signed in as ${currentUser.email}`;
      } else {
        fileStatus.textContent = 'Local-only (not signed in)';
        authStatus.textContent = 'Not signed in.';
      }
      setModeBadge();
    }

    // Import / Export
    function importJSON(obj){
  function normaliseMonth(x){
    if(!x || typeof x !== 'object') return {expenses:[], lastEdited:new Date().toISOString()};
    const src = x.data && typeof x.data==='object' ? x.data : x;
    return {
      expenses: Array.isArray(src.expenses) ? src.expenses.map(e=>({
        payer: e.payer || e.person || '',
        category: e.category || '',
        amount: typeof e.amount === 'string' ? parseFloat(e.amount.replace(',','.')) : (+e.amount||0),
        note: e.note || '',
        splits: (e.splits && typeof e.splits==='object') ? e.splits : (e.payer||e.person ? {[e.payer||e.person]:100} : {})
      })) : [],
      lastEdited: src.lastEdited || new Date().toISOString()
    };
  }

  const nowMonth = monthEl.value || thisMonthValue();
  const allPeople = new Set(fileData.people || []);
  const allCategories = new Set(fileData.categories || []);

  // Check if import has global people/categories structure
  if(obj && obj.people && Array.isArray(obj.people)){
    obj.people.forEach(p => allPeople.add(String(p).trim()));
  }
  if(obj && obj.categories && Array.isArray(obj.categories)){
    obj.categories.forEach(c => allCategories.add(String(c).trim()));
  }

  if(obj && obj.months && typeof obj.months === 'object'){
    for(const [m, val] of Object.entries(obj.months)){
      const src = val.data && typeof val.data==='object' ? val.data : val;
      // Extract people and categories from old format
      if(Array.isArray(src.people)){
        src.people.forEach(p => allPeople.add(String(p).trim()));
      }
      if(Array.isArray(src.categories)){
        src.categories.forEach(c => allCategories.add(String(c).trim()));
      }
      fileData.months[m] = normaliseMonth(val);
    }
  } else if (obj && (obj.people || obj.categories || obj.expenses || obj.data)){
    const src = obj.data && typeof obj.data==='object' ? obj.data : obj;
    if(Array.isArray(src.people)){
      src.people.forEach(p => allPeople.add(String(p).trim()));
    }
    if(Array.isArray(src.categories)){
      src.categories.forEach(c => allCategories.add(String(c).trim()));
    }
    fileData.months[nowMonth] = normaliseMonth(obj);
  } else {
    throw new Error('This file is valid JSON but not a recognised Family Accounts export.');
  }

  // Update global people and categories
  fileData.people = Array.from(allPeople).filter(Boolean);
  fileData.categories = Array.from(allCategories).filter(Boolean);
  saveGlobalToLocal();

  for(const m of Object.keys(fileData.months)){
    try{ localStorage.setItem(keyFor(m), JSON.stringify(fileData.months[m])); }catch{}
  }
  if(currentUser){ saveRemote().catch(()=>{}); }
  if(fileData.months[nowMonth]){ data = fileData.months[nowMonth]; }
  renderAll();
  renderAverages();
}

importBtn.addEventListener('click', ()=> importInput.click());

importInput.addEventListener('change', async (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  try{
    const rawText = await f.text();
    const text = String(rawText).replace(/^\uFEFF/, '').trim();

    const head = text.slice(0, 200).toLowerCase();
    if(head.includes('<!doctype') || head.includes('<html')){
      alert('That file looks like an HTML page, not JSON. If downloading from GitHub, click "Raw" before saving.');
      return;
    }

    let obj;
    try {
      obj = JSON.parse(text);
    } catch {
      const stripped = text.replace(/\/\*[\s\S]*?\*\//g, '').replace(/(^|[^:])\/\/.*$/gm, '$1');
      obj = JSON.parse(stripped);
    }

    importJSON(obj);
    alert('Import complete!');

  }catch(err){
    alert('Could not read that JSON.');
    console.error(err);
  } finally {
    importInput.value = '';
  }
});


    function buildExportPayload(){
      if(currentUser){
        return fileData;
      }
      const months = {};
      for(const m of listSavedMonthsLocal()){
        const raw = localStorage.getItem(keyFor(m));
        if(!raw) continue;
        try{ months[m] = JSON.parse(raw); }catch{}
      }
      return {
        people: fileData.people || [],
        categories: fileData.categories || [],
        months
      };
    }

    function exportJSON(){
      const payload = buildExportPayload();
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `family-accounts-backup-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ---------- Month switching ----------
    async function switchMonthSafely(targetMonth){
      if(targetMonth === lastLoadedMonth) return;
      if(monthExists(targetMonth)){
        await loadFromFileOrLocal(targetMonth);
      } else {
        // Create new month with empty expenses (people/categories are global now)
        const fresh = defaultData();
        if(currentUser){
          fileData.months[targetMonth] = fresh;
        } else {
          localStorage.setItem(keyFor(targetMonth), JSON.stringify(fresh));
        }
        data = fresh;
      }
      lastLoadedMonth = targetMonth;
      monthEl.value = targetMonth;
      renderLastEdited();
      persist();
      renderAll();
    }

    // ---------- Public actions ----------
    function setMonthToNow(){ monthEl.value = thisMonthValue(); }
    function loadMonth(month){ loadFromFileOrLocal(month).then(()=>{ renderAll(); renderAverages(); }); }

    function save(){ setLastEditedNow(); persist(); }
    function addPerson(name){
      name = (name||'').trim(); if(!name) return; if((fileData.people||[]).includes(name)) return;
      (fileData.people = fileData.people||[]).push(name); saveGlobalToLocal(); renderPeopleCats();
    }
    function removePerson(name){
      // Remove from global list
      fileData.people = (fileData.people||[]).filter(p=>p!==name);
      saveGlobalToLocal();

      // Remove from current month expenses
      data.expenses = (data.expenses||[]).filter(e=>e.payer!==name && e.person!==name);

      // If using Supabase, remove from all months
      if(currentUser && fileData.months){
        for(const month in fileData.months){
          if(fileData.months[month] && fileData.months[month].expenses){
            fileData.months[month].expenses = fileData.months[month].expenses.filter(e=>e.payer!==name && e.person!==name);
          }
        }
      } else {
        // If using local storage, clean up all saved months
        for(const month of listSavedMonthsLocal()){
          const raw = localStorage.getItem(keyFor(month));
          if(raw){
            try{
              const monthData = JSON.parse(raw);
              if(monthData.expenses){
                monthData.expenses = monthData.expenses.filter(e=>e.payer!==name && e.person!==name);
                localStorage.setItem(keyFor(month), JSON.stringify(monthData));
              }
            }catch{}
          }
        }
      }

      save(); renderAll();
    }
    function addCategory(name){
      name = (name||'').trim(); if(!name) return; if((fileData.categories||[]).includes(name)) return;
      (fileData.categories = fileData.categories||[]).push(name); saveGlobalToLocal(); renderPeopleCats();
    }
    function removeCategory(name){
      // Remove from global list
      fileData.categories = (fileData.categories||[]).filter(c=>c!==name);
      saveGlobalToLocal();

      // Remove from current month expenses
      data.expenses = (data.expenses||[]).filter(e=>e.category!==name);

      // If using Supabase, remove from all months
      if(currentUser && fileData.months){
        for(const month in fileData.months){
          if(fileData.months[month] && fileData.months[month].expenses){
            fileData.months[month].expenses = fileData.months[month].expenses.filter(e=>e.category!==name);
          }
        }
      } else {
        // If using local storage, clean up all saved months
        for(const month of listSavedMonthsLocal()){
          const raw = localStorage.getItem(keyFor(month));
          if(raw){
            try{
              const monthData = JSON.parse(raw);
              if(monthData.expenses){
                monthData.expenses = monthData.expenses.filter(e=>e.category!==name);
                localStorage.setItem(keyFor(month), JSON.stringify(monthData));
              }
            }catch{}
          }
        }
      }

      save(); renderAll();
    }
    function parseAmounts(text){
      const tokens = String(text).split(/[\s,;]+/).map(t=>t.trim()).filter(Boolean);
      const nums = [];
      for(const t of tokens){ const cleaned=t.replace(/\u20ac/g,'').replace(/,/g,'.'); const n=parseFloat(cleaned); if(!isNaN(n)) nums.push(n); }
      return nums;
    }

    function addQuickExpenses(){
      const payer = quickPerson.value;
      const category = quickCategory.value;
      if(!payer || !category){ alert('Please select a person and category'); return; }
      const amounts = parseAmounts(quickAmounts.value);
      if(!amounts.length){ alert('Add at least one amount'); return; }
      const note = document.getElementById('quickNote') ? document.getElementById('quickNote').value.trim() : '';
      const choice = quickSplit.value || '50_50';
      const splits = computeSplitsFromChoice(choice, payer);
      for(const a of amounts){ if(a<=0) continue; (data.expenses = data.expenses||[]).push({payer, category, amount: round2(+a), note, splits}); }
      save(); renderAll(); quickAmounts.value='';
    }

    function makeBatchRow(category=''){
      const row=document.createElement('div'); row.className='row';
      row.innerHTML='\
        <div class="col" style="flex:1;min-width:160px"><label>Category</label><select class="batchCategory"></select></div>\
        <div class="col" style="width:160px"><label>Amount</label><input class="batchAmount" type="number" inputmode="decimal" step="0.01" placeholder="0.00"/></div>\
        <div class="col" style="flex:1;min-width:200px"><label>Note (optional)</label><input class="batchNote" type="text" placeholder="e.g., receipt #1234"/></div>\
        <button class="btn ghost removeRowBtn" type="button" title="Remove">üóëÔ∏è</button>';
      const sel=row.querySelector('.batchCategory'); fillSelect(sel, (fileData.categories||[])); if(category) sel.value=category;
      row.querySelector('.removeRowBtn').addEventListener('click',()=>row.remove());
      return row;
    }
    function saveBatch(){
      const payer=batchPerson.value; if(!payer){ alert('Select a person'); return; }
      const rows=[...batchRows.querySelectorAll('.row')]; if(!rows.length){ alert('Add at least one line'); return; }
      const choice = batchSplit.value || '50_50';
      const splits = computeSplitsFromChoice(choice, payer);
      let added=0;
      for(const r of rows){
        const cat=r.querySelector('.batchCategory').value;
        const val=parseFloat(r.querySelector('.batchAmount').value);
        const note=(r.querySelector('.batchNote')?.value||'').trim();
        if(cat && isFinite(val) && val>0){ (data.expenses = data.expenses||[]).push({payer, category:cat, amount: round2(val), note, splits}); added++; }
      }
      if(!added){ alert('Please enter valid amounts'); return; }
      batchRows.innerHTML=''; save(); renderAll();
    }

    // ---------- Init & events ----------
    document.addEventListener('DOMContentLoaded', async ()=>{
      initSupabase();
      if(supabaseClient){
        await refreshSession();

        // Handle email confirmation and password reset links
        const handleAuthCallback = async () => {
          const hashParams = new URLSearchParams(window.location.hash.substring(1));
          const type = hashParams.get('type');
          const error = hashParams.get('error');
          const errorDescription = hashParams.get('error_description');

          if(error){
            showAuthMessage(decodeURIComponent(errorDescription || error), 'error');
            // Clean up URL
            window.history.replaceState({}, document.title, window.location.pathname);
            return;
          }

          if(type === 'signup'){
            showAuthMessage('Email confirmed! You can now sign in.', 'success');
            window.history.replaceState({}, document.title, window.location.pathname);
          } else if(type === 'recovery'){
            const newPassword = prompt('Enter your new password (min. 6 characters):');
            if(newPassword && validatePassword(newPassword)){
              try {
                const { error: updateError } = await supabaseClient.auth.updateUser({ password: newPassword });
                if(updateError){
                  showAuthMessage(updateError.message, 'error');
                } else {
                  showAuthMessage('Password updated successfully! You are now signed in.', 'success');
                  authPassword.value = '';
                }
              } catch(err){
                showAuthMessage('Failed to update password. Please try again.', 'error');
              }
            } else if(newPassword){
              showAuthMessage('Password must be at least 6 characters long.', 'error');
            }
            window.history.replaceState({}, document.title, window.location.pathname);
          }
        };

        // Check for auth callback on page load
        if(window.location.hash){
          await handleAuthCallback();
        }

        supabaseClient.auth.onAuthStateChange(async (event, session) => {
          currentUser = session?.user || null;
          if(currentUser){
            await loadRemote();
            await loadFromFileOrLocal(monthEl.value);
          }
          updateFileStatus();
          renderAll();
          renderAverages();

          // Handle specific auth events
          if(event === 'SIGNED_IN' && !window.location.hash){
            // Only show if not from callback (callback shows its own message)
            authStatus.textContent = `Signed in as ${currentUser?.email || ''}`;
          } else if(event === 'SIGNED_OUT'){
            authStatus.textContent = 'Not signed in.';
          }
        });
      }
      const initial = thisMonthValue();
      monthEl.value = initial;
      if(currentUser){
        await loadRemote();
      } else {
        // Load global people/categories from local storage if not using Supabase
        loadGlobalFromLocal();
      }
      await loadFromFileOrLocal(initial);
      lastLoadedMonth = initial;
      setupCollapsibles();
      renderAll();
      renderAverages();
      updateFileStatus();

      monthEl.addEventListener('change', async ()=>{
        const target = monthEl.value;
        await switchMonthSafely(target);
        buildSplitOptions(quickSplit);
        buildSplitOptions(batchSplit);
      });

      addPersonBtn.addEventListener('click', ()=>{
        const v = personNameEl.value; personNameEl.value=''; addPerson(v); personNameEl.focus();
        buildSplitOptions(quickSplit); buildSplitOptions(batchSplit);
      });
      personNameEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ addPersonBtn.click(); }});

      addCategoryBtn.addEventListener('click', ()=>{
        const v = categoryNameEl.value; categoryNameEl.value=''; addCategory(v); categoryNameEl.focus();
      });

      modeQuickBtn.addEventListener('click', ()=>{
        modeQuickBtn.classList.add('active'); modeBatchBtn.classList.remove('active');
        quickPanel.style.display='block'; batchPanel.style.display='none';
      });
      modeBatchBtn.addEventListener('click', ()=>{
        modeBatchBtn.classList.add('active'); modeQuickBtn.classList.remove('active');
        quickPanel.style.display='none'; batchPanel.style.display='block';
        if(!batchRows.children.length) batchRows.appendChild(makeBatchRow());
      });

      addQuickBtn.addEventListener('click', addQuickExpenses);
      clearQuickBtn.addEventListener('click', ()=>{ quickAmounts.value=''; });

      addBatchRowBtn.addEventListener('click', ()=> batchRows.appendChild(makeBatchRow()));
      saveBatchBtn.addEventListener('click', saveBatch);
      clearBatchBtn.addEventListener('click', ()=>{ batchRows.innerHTML=''; });

      clearMonthBtn.addEventListener('click', ()=>{
        const msg = "Are you sure you want to delete this month's expenses? You won't be able to get them back.";
        if(confirm(msg)){
          const m = monthEl.value;
          const safeName = (s)=> s.replace(/[^A-Za-z0-9_\-]/g,'-');
          const monthLabel = new Date(m + '-01T00:00:00').toLocaleString('en-GB',{month:'long', year:'numeric'}).replace(' ', '-');
          const backup = {months:{}}; backup.months[m] = JSON.parse(JSON.stringify(data));
          const blob = new Blob([JSON.stringify(backup, null, 2)], {type:'application/json'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href=url; a.download=`family-accounts-backup-${safeName(monthLabel)}.json`;
          document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
          data.expenses = []; save(); renderAll();
        }
      });

      exportBtn.addEventListener('click', exportJSON);

      signInBtn.addEventListener('click', async ()=>{
        hideAuthMessage();
        if(!supabaseClient){
          showAuthMessage('Supabase is not configured. Please add your credentials to the code.', 'error');
          return;
        }
        const email = authEmail.value.trim();
        const password = authPassword.value;

        // Validation
        if(!email || !password){
          showAuthMessage('Please enter both email and password.', 'error');
          return;
        }
        if(!validateEmail(email)){
          showAuthMessage('Please enter a valid email address.', 'error');
          return;
        }

        setButtonLoading(signInBtn, true);
        try {
          const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
          if(error){
            showAuthMessage(error.message, 'error');
            return;
          }
          await refreshSession();
          await loadRemote();
          await loadFromFileOrLocal(monthEl.value);
          updateFileStatus();
          renderAll();
          renderAverages();
          showAuthMessage(`Successfully signed in as ${currentUser?.email || ''}`, 'success');
          authPassword.value = ''; // Clear password field
        } finally {
          setButtonLoading(signInBtn, false);
        }
      });

      signUpBtn.addEventListener('click', async ()=>{
        hideAuthMessage();
        if(!supabaseClient){
          showAuthMessage('Supabase is not configured. Please add your credentials to the code.', 'error');
          return;
        }
        const email = authEmail.value.trim();
        const password = authPassword.value;

        // Validation
        if(!email || !password){
          showAuthMessage('Please enter both email and password.', 'error');
          return;
        }
        if(!validateEmail(email)){
          showAuthMessage('Please enter a valid email address.', 'error');
          return;
        }
        if(!validatePassword(password)){
          showAuthMessage('Password must be at least 6 characters long.', 'error');
          return;
        }

        setButtonLoading(signUpBtn, true);
        try {
          const { data, error } = await supabaseClient.auth.signUp({ email, password });
          if(error){
            showAuthMessage(error.message, 'error');
            return;
          }

          // Check if email confirmation is required
          if(data?.user && !data.session){
            showAuthMessage('Account created! Check your email to confirm your account, then sign in.', 'success');
            authPassword.value = ''; // Clear password field
          } else if(data?.session){
            // Auto-confirmation is enabled, user is already signed in
            showAuthMessage('Account created and signed in successfully!', 'success');
            authPassword.value = '';
          }
        } finally {
          setButtonLoading(signUpBtn, false);
        }
      });

      signOutBtn.addEventListener('click', async ()=>{
        if(!supabaseClient){ return; }
        hideAuthMessage();
        setButtonLoading(signOutBtn, true);
        try {
          await supabaseClient.auth.signOut();
          currentUser = null;
          fileData = { people: [], categories: [], months: {} };
          // Load global data from local storage after signing out
          loadGlobalFromLocal();
          updateFileStatus();
          renderAll();
          renderAverages();
          showAuthMessage('Successfully signed out.', 'success');
          authPassword.value = ''; // Clear password field
        } finally {
          setButtonLoading(signOutBtn, false);
        }
      });

      forgotPasswordBtn.addEventListener('click', async ()=>{
        hideAuthMessage();
        if(!supabaseClient){
          showAuthMessage('Supabase is not configured. Please add your credentials to the code.', 'error');
          return;
        }
        const email = authEmail.value.trim();

        // Validation
        if(!email){
          showAuthMessage('Please enter your email address.', 'error');
          return;
        }
        if(!validateEmail(email)){
          showAuthMessage('Please enter a valid email address.', 'error');
          return;
        }

        if(!confirm(`Send password reset email to ${email}?`)){
          return;
        }

        setButtonLoading(forgotPasswordBtn, true);
        try {
          const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
            redirectTo: window.location.origin + window.location.pathname
          });
          if(error){
            showAuthMessage(error.message, 'error');
            return;
          }
          showAuthMessage('Password reset email sent! Check your inbox.', 'success');
        } finally {
          setButtonLoading(forgotPasswordBtn, false);
        }
      });

      // Keyboard support: Enter key on password field triggers sign in
      authPassword.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter'){
          e.preventDefault();
          signInBtn.click();
        }
      });

      // Keyboard support: Enter key on email field focuses password
      authEmail.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter'){
          e.preventDefault();
          authPassword.focus();
        }
      });

      // initial split options
      buildSplitOptions(quickSplit);
      buildSplitOptions(batchSplit);
    });
  </script>
</body>
</html>
